<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Dashboard | IIE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .kpi-card { transition: transform 0.2s, box-shadow 0.2s; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; transition: opacity 0.5s;
        }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .manager-only { display: none; } /* Hidden by default, shown for managers via JS */
    </style>
</head>
<body class="bg-gray-50">

    <div id="loader-overlay">
        <div class="loader"></div>
        <p class="mt-4 text-lg font-semibold text-gray-700">Loading Finance Portal...</p>
    </div>

    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <img src="IMG-20230327-WA0002.jpg" alt="Institute Logo" class="h-12 w-12 rounded-md shadow-sm">
                <h1 class="text-xl font-bold text-gray-800">Finance Portal</h1>
            </div>
            <div class="flex items-center space-x-4">
                <div id="user-info" class="text-right">
                    <p class="font-semibold text-gray-700" id="userName">Welcome</p>
                    <p class="text-sm text-gray-500" id="userRole">Finance Team</p>
                </div>
                <button id="logoutButton" title="Logout" class="bg-red-500 text-white font-semibold px-4 py-2 rounded-md hover:bg-red-600 transition">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6">
        <section id="kpi-section" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="kpi-card bg-blue-600 text-white p-6 rounded-lg shadow-lg"><h2 class="text-lg font-semibold">Final Balance</h2><p id="total-balance" class="text-3xl font-bold mt-2">₹0.00</p></div>
            <div class="kpi-card bg-green-600 text-white p-6 rounded-lg shadow-lg"><h2 class="text-lg font-semibold">Total Income</h2><p id="total-income" class="text-3xl font-bold mt-2">₹0.00</p><p id="income-last-month" class="text-sm mt-1 opacity-90">Last 30 days: ₹0.00</p></div>
            <div class="kpi-card bg-red-600 text-white p-6 rounded-lg shadow-lg"><h2 class="text-lg font-semibold">Total Expenditure</h2><p id="total-expenditure" class="text-3xl font-bold mt-2">₹0.00</p><p id="expenditure-last-month" class="text-sm mt-1 opacity-90">Last 30 days: ₹0.00</p></div>
            <div class="kpi-card bg-yellow-500 text-white p-6 rounded-lg shadow-lg"><h2 class="text-lg font-semibold">Net Flow (30 Days)</h2><p id="net-flow" class="text-3xl font-bold mt-2">₹0.00</p></div>
        </section>

        <section class="bg-white p-4 rounded-lg shadow-md mb-8 flex flex-wrap justify-between items-center gap-4">
            <div class="flex items-center space-x-4"><button id="add-income-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 transition"><i class="fa-solid fa-plus mr-2"></i>Add Income</button><button id="add-expenditure-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-md hover:bg-red-600 transition"><i class="fa-solid fa-minus mr-2"></i>Add Expenditure</button></div>
            <div class="flex items-center space-x-4"><button id="download-pdf-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition"><i class="fa-solid fa-file-pdf mr-2"></i>Download PDF</button><button id="send-report-btn" class="manager-only bg-gray-700 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-800 transition"><i class="fa-solid fa-paper-plane mr-2"></i>Send Report</button></div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-2xl font-bold mb-4 text-green-700">Income Records</h2><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase manager-only">Actions</th></tr></thead><tbody id="income-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>
            <div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-2xl font-bold mb-4 text-red-700">Expenditure Records</h2><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase manager-only">Actions</th></tr></thead><tbody id="expenditure-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>
        </section>
        <section class="mt-8 manager-only bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Finance Team Members</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Full Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                        </tr>
                    </thead>
                    <tbody id="finance-team-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </section>
    </main>

    <div id="record-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0"><div class="modal-content bg-white p-8 rounded-lg shadow-2xl max-w-md w-full transform -translate-y-10"><h2 id="modal-title" class="text-2xl font-bold mb-6 text-center">Add Record</h2><form id="record-form" class="space-y-4"><input type="hidden" id="record-type" name="type"><input type="hidden" id="record-id" name="id"><div><label for="description" class="block text-sm font-medium text-gray-700">Description</label><input type="text" id="description" name="description" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="amount" class="block text-sm font-medium text-gray-700">Amount (₹)</label><input type="number" id="amount" name="amount" required min="0.01" step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="date" class="block text-sm font-medium text-gray-700">Date</label><input type="date" id="date" name="date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="receiptNo" class="block text-sm font-medium text-gray-700">Receipt / Bill No.</label><input type="text" id="receiptNo" name="receiptNo" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div class="pt-4 flex justify-end space-x-4"><button type="button" id="cancel-btn" class="bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button><button type="submit" id="submit-record-btn" class="text-white font-bold px-4 py-2 rounded-md">Submit</button></div></form></div></div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuration & State ---
            const API_URL = "https://script.google.com/macros/s/AKfycbx6T43AwXJvLYlYyzdASc_8ggtodiGe1yjmXw8RiyMtIUo_qbB2oJIrJfZOZS_wUlxuWQ/exec";
            const token = localStorage.getItem("sessionToken"); // Use the same token as other portals
            let userRole = '';
            let allIncome = [];
            let allExpenditure = [];

            // --- Authentication Check ---
            if (!token) {
                window.location.href = "login.html"; // Redirect to a common login page
                return;
            }

            // --- UI Element References ---
            const loader = document.getElementById('loader-overlay');
            const modal = document.getElementById('record-modal');
            const modalContent = modal.querySelector('.modal-content');
            const recordForm = document.getElementById('record-form');
            const modalTitle = document.getElementById('modal-title');
            const submitBtn = document.getElementById('submit-record-btn');
            
            // --- Utility Functions ---
            const showLoader = (text = 'Processing...') => {
                loader.querySelector('p').textContent = text;
                loader.classList.remove('hidden');
            };
            const hideLoader = () => loader.classList.add('hidden');
            const showToast = (message, isError = false) => {
                Toastify({ text: message, duration: 3000, close: true, gravity: "top", position: "right", style: { background: isError ? "linear-gradient(to right, #ef4444, #b91c1c)" : "linear-gradient(to right, #22c55e, #15803d)" }}).showToast();
            };
            const formatCurrency = (value) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(value);

            // --- Modal Management ---
            const openModal = (type, record = null) => {
                recordForm.reset();
                document.getElementById('record-type').value = type;
                document.getElementById('date').valueAsDate = new Date(); // Default to today

                const isEdit = record !== null;
                const typeText = type.charAt(0).toUpperCase() + type.slice(1);

                modalTitle.textContent = isEdit ? `Edit ${typeText}` : `Add New ${typeText}`;
                submitBtn.textContent = isEdit ? 'Save Changes' : `Add ${typeText}`;

                if (type === 'income') {
                    modalTitle.className = 'text-2xl font-bold mb-6 text-center text-green-700';
                    submitBtn.className = 'bg-green-600 text-white font-bold px-4 py-2 rounded-md hover:bg-green-700';
                } else {
                    modalTitle.className = 'text-2xl font-bold mb-6 text-center text-red-700';
                    submitBtn.className = 'bg-red-600 text-white font-bold px-4 py-2 rounded-md hover:bg-red-700';
                }

                if (isEdit) {
                    document.getElementById('record-id').value = record[0]; // RecordID
                    document.getElementById('description').value = record[2]; // Description
                    document.getElementById('amount').value = record[3]; // Amount
                    document.getElementById('date').value = new Date(record[4]).toISOString().split('T')[0]; // Date
                    document.getElementById('receiptNo').value = record[5]; // ReceiptNo
                }
                
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modalContent.classList.remove('-translate-y-10');
                }, 10);
            };

            const closeModal = () => {
                modal.classList.add('opacity-0');
                modalContent.classList.add('-translate-y-10');
                setTimeout(() => modal.classList.add('hidden'), 300);
            };

            // --- API Call Functions ---
            const postData = (payload, callback) => {
                showLoader();
                payload.token = token;
                fetch(API_URL, {
                    method: 'POST', redirect: 'follow', body: JSON.stringify(payload),
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'error') throw new Error(data.message);
                    if (callback) callback(data);
                })
                .catch(err => {
                    showToast(err.message, true);
                    if (err.message.includes("Unauthorized")) {
                        localStorage.removeItem("sessionToken");
                        window.location.href = "login.html";
                    }
                })
                .finally(hideLoader);
            };

            // --- Data Rendering & Calculation ---
            const renderDashboard = (data) => {
                // Store data globally for PDF generation
                allIncome = data.income || [['RecordID', 'UserID', 'Description', 'Amount', 'Date', 'ReceiptNo']];
                allExpenditure = data.expenditure || [['RecordID', 'UserID', 'Description', 'Amount', 'Date', 'ReceiptNo']];
                renderFinanceTeam(data.financeTeam);

                // Render User Info & Apply Role-Based Access
                const user = data.userProfile;
                if (user) {
                    userRole = user.role;
                    document.getElementById('userName').textContent = `Welcome, ${user.fullName}`;
                    document.getElementById('userRole').textContent = user.role;
                    if (user.role === 'Manager') {
                        document.querySelectorAll('.manager-only').forEach(el => el.style.display = 'table-cell'); // Or 'block' if not a table cell
                    }
                }

                renderTable(allIncome, document.getElementById('income-table-body'), 'income');
                renderTable(allExpenditure, document.getElementById('expenditure-table-body'), 'expenditure');

                // Calculate and Render KPIs
                const incomeRecords = allIncome.slice(1);
                const expenditureRecords = allExpenditure.slice(1);
                const amountIndex = 3, dateIndex = 4; // Based on new structure with ID and UserID

                const totalIncome = incomeRecords.reduce((sum, row) => sum + parseFloat(row[amountIndex] || 0), 0);
                const totalExpenditure = expenditureRecords.reduce((sum, row) => sum + parseFloat(row[amountIndex] || 0), 0);
                
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                const incomeLastMonth = incomeRecords.filter(row => new Date(row[dateIndex]) >= thirtyDaysAgo).reduce((sum, row) => sum + parseFloat(row[amountIndex] || 0), 0);
                const expenditureLastMonth = expenditureRecords.filter(row => new Date(row[dateIndex]) >= thirtyDaysAgo).reduce((sum, row) => sum + parseFloat(row[amountIndex] || 0), 0);
                
                document.getElementById('total-balance').textContent = formatCurrency(totalIncome - totalExpenditure);
                document.getElementById('total-income').textContent = formatCurrency(totalIncome);
                document.getElementById('total-expenditure').textContent = formatCurrency(totalExpenditure);
                document.getElementById('income-last-month').textContent = `Last 30 days: ${formatCurrency(incomeLastMonth)}`;
                document.getElementById('expenditure-last-month').textContent = `Last 30 days: ${formatCurrency(expenditureLastMonth)}`;
                document.getElementById('net-flow').textContent = formatCurrency(incomeLastMonth - expenditureLastMonth);
            };

            const renderTable = (data, tbody, type) => {
                tbody.innerHTML = '';
                if (!data || data.length <= 1) {
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 py-4">No records found.</td></tr>`;
                    return;
                }
                const headers = data[0];
                const rows = data.slice(1);
                rows.forEach(row => {
                    const recordId = row[0];
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-800">${row[2]}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${formatCurrency(row[3])}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${new Date(row[4]).toLocaleDateString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 space-x-2 manager-only">
                            <button class="edit-btn text-blue-600 hover:text-blue-800" data-id="${recordId}" data-type="${type}" title="Edit"><i class="fa-solid fa-pencil"></i></button>
                            <button class="delete-btn text-red-600 hover:text-red-800" data-id="${recordId}" data-type="${type}" title="Delete"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                if (userRole === 'Manager') {
                    tbody.querySelectorAll('.manager-only').forEach(el => el.style.display = 'table-cell');
                }
            };

            const renderFinanceTeam = (teamData) => {
                const tbody = document.getElementById('finance-team-table-body');
                tbody.innerHTML = '';
                if (!teamData || teamData.length <= 1) {
                    tbody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-500 py-4">No team data found.</td></tr>`;
                    return;
                }
                const teamRows = teamData.slice(1); // Skip headers
                teamRows.forEach(row => {
                    const tr = document.createElement('tr');
                    // Columns from Finance sheet: FullName (1), Email (2), Role (3)
                    tr.innerHTML = `
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${row[1]}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${row[2]}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${row[3]}</td>
                    `;
                    tbody.appendChild(tr);
                });
            };

            // --- Main Data Fetch Function ---
            const fetchFinanceData = () => {
                showLoader('Loading Finance Data...');
                postData({ action: 'getFinanceData' }, (data) => {
                    renderDashboard(data);
                    hideLoader();
                });
            };

            // --- Event Handlers ---
            document.getElementById('logoutButton').addEventListener('click', () => {
                showLoader('Logging out...');
                localStorage.removeItem('sessionToken');
                window.location.href = 'login.html';
            });

            document.getElementById('add-income-btn').addEventListener('click', () => openModal('income'));
            document.getElementById('add-expenditure-btn').addEventListener('click', () => openModal('expenditure'));
            document.getElementById('cancel-btn').addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

            recordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(recordForm);
                const recordData = Object.fromEntries(formData.entries());
                const action = recordData.id ? 'updateRecord' : 'addRecord';
                
                postData({ action: action, data: recordData }, (response) => {
                    showToast(response.message);
                    closeModal();
                    fetchFinanceData(); // Refresh data
                });
            });

            document.querySelector('#income-table-body, #expenditure-table-body').addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                
                const id = button.dataset.id;
                const type = button.dataset.type;
                const sourceData = type === 'income' ? allIncome : allExpenditure;
                const record = sourceData.slice(1).find(row => row[0] === id);

                if (button.classList.contains('edit-btn')) {
                    openModal(type, record);
                } else if (button.classList.contains('delete-btn')) {
                    if (confirm(`Are you sure you want to delete this ${type} record? This cannot be undone.`)) {
                        postData({ action: 'deleteRecord', data: { id, type } }, (response) => {
                            showToast(response.message);
                            fetchFinanceData();
                        });
                    }
                }
            });
            
            document.getElementById('send-report-btn').addEventListener('click', () => {
                if (confirm("Are you sure you want to send the weekly finance report now?")) {
                    postData({ action: 'sendFinanceReport' }, (response) => showToast(response.message));
                }
            });

            document.getElementById('download-pdf-btn').addEventListener('click', () => {
                showLoader('Generating PDF...');
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const today = new Date().toLocaleDateString();

                doc.setFontSize(18);
                doc.text("Institute of Islamic Education - Finance Report", 14, 22);
                doc.setFontSize(11);
                doc.text(`Generated on: ${today}`, 14, 30);

                const incomeBody = allIncome.slice(1).map(row => [row[2], formatCurrency(row[3]), new Date(row[4]).toLocaleDateString(), row[5]]);
                doc.autoTable({
                    head: [['Description', 'Amount', 'Date', 'Receipt No.']],
                    body: incomeBody,
                    startY: 40,
                    headStyles: { fillColor: [22, 163, 74] },
                    didParseCell: (data) => { if(data.column.index === 1) data.cell.styles.halign = 'right'; }
                });

                const expenditureBody = allExpenditure.slice(1).map(row => [row[2], formatCurrency(row[3]), new Date(row[4]).toLocaleDateString(), row[5]]);
                doc.autoTable({
                    head: [['Description', 'Amount', 'Date', 'Bill No.']],
                    body: expenditureBody,
                    startY: doc.autoTable.previous.finalY + 15,
                    headStyles: { fillColor: [220, 38, 38] },
                    didParseCell: (data) => { if(data.column.index === 1) data.cell.styles.halign = 'right'; }
                });
                
                const finalY = doc.autoTable.previous.finalY;
                doc.setFontSize(12);
                doc.text("Summary:", 14, finalY + 20);
                doc.autoTable({
                    body: [
                        ['Total Income:', document.getElementById('total-income').textContent],
                        ['Total Expenditure:', document.getElementById('total-expenditure').textContent],
                        [{ content: 'Final Balance:', styles: { fontStyle: 'bold' } }, { content: document.getElementById('total-balance').textContent, styles: { fontStyle: 'bold' } }]
                    ],
                    startY: finalY + 25,
                    theme: 'plain'
                });

                doc.save(`IIE-Finance-Report-${new Date().toISOString().split('T')[0]}.pdf`);
                hideLoader();
            });

            // --- Initial Load ---
            fetchFinanceData();
        });
    </script>
</body>
</html>