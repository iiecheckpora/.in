<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Dashboard | IIE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Mirza:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; }
        .body-no-scroll { overflow: hidden; }
        .toastify { font-family: 'Inter', sans-serif; border-radius: 0.5rem; }
        .kpi-card { transition: transform 0.2s, box-shadow 0.2s; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .manager-only { display: none; }
        .note-icon { cursor: pointer; color: #6b7280; }
        [lang="ar"] { font-family: 'Mirza', serif; }
        .scroll-target { scroll-margin-top: 80px; }

        html, body {
            height: 100%;
            width: 100%;
            overflow-x: hidden; /* This also helps with the horizontal scroll issue */
        }
        /* Sidebar Styles */
        #sidebar { 
            transition: transform 0.3s ease-in-out; 
            background-color: #1e3a8a;
            height: 100vh;
            height: 100dvh;
        }
        #sidebar.open { transform: translateX(0); }
        .sidebar-link { transition: background-color 0.2s, color 0.2s; }
        .sidebar-link:hover { background-color: #2563eb; color: white; }
        .sidebar-link.active { background-color: #1d4ed8; color: white; font-weight: 600; }
        
        /* Loader Animation Styles (from admin.html) */
        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #ffffff; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
            transition: opacity 0.75s ease-in-out, visibility 0.75s;
            opacity: 1; visibility: visible; text-align: center;
        }
        #loader-overlay.hidden { opacity: 0; visibility: hidden; }
        .loader-logo { width: 80px; height: 80px; animation: pulse-zoom 2s infinite cubic-bezier(0.4, 0, 0.6, 1); }
        .loader-text { margin-top: 1rem; font-size: 1.125rem; font-weight: 600; color: #1e3a8a; animation: text-fade 2s infinite ease-in-out; }
        .loader-quote { margin-top: 1.5rem; font-size: 1rem; font-style: italic; color: #4b5563; max-width: 90vw; width: 500px; padding: 0 1rem; }
        @keyframes pulse-zoom { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } }
        @keyframes text-fade { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* Notification Loader Styles */
        .notification-loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 120px;
        }
        .cube {
            width: 40px;
            height: 40px;
            position: relative;
            transform-style: preserve-3d;
            animation: spin-cube 1.2s infinite linear;
        }
        .cube-face {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #3b82f6;
            opacity: 0.8;
            border: 2px solid #2563eb;
        }
        .cube-face.front  { transform: rotateY(  0deg) translateZ(20px); }
        .cube-face.back   { transform: rotateY(180deg) translateZ(20px); }
        .cube-face.right  { transform: rotateY( 90deg) translateZ(20px); }
        .cube-face.left   { transform: rotateY(-90deg) translateZ(20px); }
        .cube-face.top    { transform: rotateX( 90deg) translateZ(20px); }
        .cube-face.bottom { transform: rotateX(-90deg) translateZ(20px); }

        @keyframes spin-cube {
            0%   { transform: rotateX(0deg) rotateY(0deg); }
            100% { transform: rotateX(360deg) rotateY(360deg); }
        }
        .bell-animate {
            animation: bell-swing 0.7s infinite cubic-bezier(0.4,0,0.6,1);
            transform-origin: top center;
        }
        @keyframes bell-swing {
            0%   { transform: rotate(0deg);}
            20%  { transform: rotate(-20deg);}
            40%  { transform: rotate(15deg);}
            60%  { transform: rotate(-10deg);}
            80%  { transform: rotate(5deg);}
            100% { transform: rotate(0deg);}
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loader-overlay">
        <img src="IMG-20230327-WA0002.jpg" alt="Institute Logo" class="loader-logo">
        <p class="loader-text">Loading Finance Portal...</p>
        <p id="loader-motivation-text" class="loader-quote"></p>
    </div>

    <aside id="sidebar" class="text-gray-100 w-64 p-4 flex flex-col fixed top-0 right-0 bottom-0 z-[60] translate-x-full lg:translate-x-0">
        <a href="index.html" class="flex items-center space-x-3 pb-4 border-b border-blue-500">
            <img src="IMG-20230327-WA0002.jpg" alt="Institute Logo" class="h-12 w-12 p-0.5 bg-white shadow-md rounded-md">
            <div class="text-left">
                <h1 class="text-sm font-bold text-white leading-tight">Institute of Islamic Education</h1>
                <p class="text-sm font-bold text-green-400" lang="ar" dir="rtl">معهد التربية الاسلامية</p>
            </div>
        </a>
        <nav class="flex-grow mt-4">
            <ul class="space-y-2" id="sidebar-nav">
                <li><a href="#dashboard" class="sidebar-link active flex items-center p-2 rounded-md"><i class="fa-solid fa-tachometer-alt fa-fw mr-3"></i>Dashboard</a></li>
                <li><a href="#records" class="sidebar-link flex items-center p-2 rounded-md"><i class="fa-solid fa-file-invoice-dollar fa-fw mr-3"></i>Records</a></li>
                <li class="manager-only">
                    <a href="javascript:void(0);" id="sidebar-team-link" class="sidebar-link flex items-center p-2 rounded-md">
                        <i class="fa-solid fa-users-cog fa-fw mr-3"></i>Finance Team
                    </a>
                </li>
                <li>
                    <a href="#notifications" class="sidebar-link flex items-center p-2 rounded-md relative">
                        <i class="fa-solid fa-bell fa-fw mr-3"></i>
                        Notifications
                        <span id="sidebar-unread-count" class="absolute right-3 top-2 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center hidden"></span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="pt-4 border-t border-blue-500">
             <div id="user-info" class="bg-blue-700 p-3 rounded-lg text-center">
                <i class="fa-solid fa-user-check fa-2x text-blue-300"></i>
                <p id="userName" class="font-semibold mt-2">Welcome!</p>
                <p id="userRole" class="text-xs text-blue-300">Finance Team</p>
            </div>
            <button id="logoutButton" class="w-full mt-4 bg-red-500 text-white font-semibold py-2 rounded-md hover:bg-red-600 transition duration-200">
                <i class="fa-solid fa-right-from-bracket mr-2"></i>Logout
            </button>
        </div>
    </aside>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden lg:hidden"></div>
    <header class="bg-white shadow-md sticky top-0 z-40 lg:hidden">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="index.html">
                <img src="IMG-20230327-WA0002.jpg" alt="Institute Logo" class="h-12 w-12 p-0.5 bg-white shadow-md rounded-md">
            </a>
            <span class="text-lg font-bold text-blue-800">Finance Portal</span>
            <div class="flex items-center space-x-4">
                <button id="mobile-bell-btn" class="relative text-gray-700 focus:outline-none">
                    <i class="fa-solid fa-bell fa-lg"></i>
                    <span id="mobile-unread-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center hidden"></span>
                </button>
                
                <button id="menu-toggle-btn" class="text-gray-700">
                    <i class="fa-solid fa-bars fa-lg"></i>
                </button>
            </div>
        </div>
        <div id="notification-dropdown" class="absolute right-4 mt-2 w-80 bg-white rounded-lg shadow-lg border z-50 hidden">
            <div class="p-4 border-b font-bold text-gray-700">Notifications</div>
            <div id="dropdown-notification-list" class="max-h-80 overflow-y-auto"></div>
            <div class="p-2 text-center text-sm text-gray-400">End of notifications</div>
        </div>
    </header>
    <div class="lg:mr-64 overflow-x-hidden">

        <main class="container mx-auto p-4 sm:p-6">
            <section id="dashboard" class="scroll-target">
                <section id="kpi-section" class="flex flex-row-reverse flex-wrap justify-end gap-6 mb-8">
                    <div class="kpi-card flex-grow min-w-[180px] bg-gray-600 text-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-lg font-semibold">Balance B/F</h2>
                        <p id="balance-bf" class="text-3xl font-bold mt-2 break-all">₹0.00</p>
                    </div>
                    <div class="kpi-card flex-grow min-w-[180px] bg-green-600 text-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-lg font-semibold">Total Income</h2>
                        <p id="total-income" class="text-3xl font-bold mt-2 break-all">₹0.00</p>
                    </div>
                    <div class="kpi-card flex-grow min-w-[180px] bg-red-600 text-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-lg font-semibold">Total Expenditure</h2>
                        <p id="total-expenditure" class="text-3xl font-bold mt-2 break-all">₹0.00</p>
                    </div>
                    <div class="kpi-card flex-grow min-w-[180px] bg-yellow-500 text-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-lg font-semibold">Net Flow</h2>
                        <p id="net-flow" class="text-3xl font-bold mt-2 break-all">₹0.00</p>
                    </div>
                    <div class="kpi-card flex-grow min-w-[180px] bg-blue-600 text-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-lg font-semibold">Final Balance</h2>
                        <p id="total-balance" class="text-3xl font-bold mt-2 break-all">₹0.00</p>
                    </div>
                </section>
        
                <section class="bg-white p-4 rounded-lg shadow-md mb-8 flex flex-col sm:flex-row flex-wrap justify-center sm:justify-between items-center gap-4">
                    <div class="flex flex-wrap justify-center items-center gap-4">
                        <button id="add-income-btn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 transition"><i class="fa-solid fa-plus mr-2"></i>Add Income</button>
                        <button id="add-expenditure-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-md hover:bg-red-600 transition"><i class="fa-solid fa-minus mr-2"></i>Add Expenditure</button>
                        <a href="invoice.html" class="bg-indigo-500 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-600 transition"><i class="fa-solid fa-file-invoice mr-2"></i>Create Invoice</a>
                    </div>
                    <div class="flex flex-wrap justify-center items-center gap-4">
                        <button id="close-ledger-btn" class="manager-only bg-purple-600 text-white font-bold py-2 px-4 rounded-md hover:bg-purple-700 transition"><i class="fa-solid fa-book-bookmark mr-2"></i>Ledger Close</button>
                        <button id="download-pdf-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition"><i class="fa-solid fa-file-pdf mr-2"></i>Download PDF</button>
                        <button id="send-report-btn" class="manager-only bg-gray-700 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-800 transition"><i class="fa-solid fa-paper-plane mr-2"></i>Send Report</button>
                    </div>
                </section>
            </section>

            <section id="records" class="scroll-target grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-2xl font-bold mb-4 text-green-700">Income Records</h2><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Added By</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase manager-only">Actions</th></tr></thead><tbody id="income-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>
                <div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-2xl font-bold mb-4 text-red-700">Expenditure Records</h2><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Added By</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase manager-only">Actions</th></tr></thead><tbody id="expenditure-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>
            </section>
            <section id="notifications" class="scroll-target mt-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Notifications</h2>
                        <i class="fa-solid fa-bell text-gray-400 fa-lg"></i>
                    </div>
                    <div id="user-notification-list" class="space-y-4 max-h-[260px] overflow-y-auto pr-2">
                        <!-- Notifications will be rendered here -->
                    </div>
                </div>
            </section>
           <section id="archive-records" class="scroll-target mt-8">
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-6 border border-gray-200">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-2xl sm:text-3xl font-extrabold text-gray-900 tracking-tight">Financial Records</h2>
                            <p class="text-sm text-gray-500 mt-1">View and download income and expenditure records.</p>
                        </div>
                        <button id="download-archive-pdf-btn" class="bg-blue-700 hover:bg-blue-800 transition text-white font-semibold px-5 py-2 rounded-lg shadow flex items-center gap-2 w-full sm:w-auto">
                            <i class="fa-solid fa-file-pdf"></i>
                            Download Archive PDF
                        </button>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-gradient-to-br from-green-50 via-white to-green-100 rounded-xl shadow border border-green-200 p-5 flex flex-col">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg sm:text-xl font-bold text-green-700 flex items-center gap-2">
                                    <i class="fa-solid fa-arrow-down-long"></i>
                                    Income Records
                                </h3>
                            </div>
                            <div class="flex flex-col gap-2 mb-3 w-full">
                                <label for="incomeArchiveStartDate" class="text-green-700 text-sm font-semibold">Start Date</label>
                                <input type="date" id="incomeArchiveStartDate" class="border border-green-300 rounded-lg px-3 py-2 text-sm focus:ring-green-500 focus:border-green-500 transition w-full" placeholder="Select date">
                                <label for="incomeArchiveEndDate" class="text-green-700 text-sm font-semibold">End Date</label>
                                <input type="date" id="incomeArchiveEndDate" class="border border-green-300 rounded-lg px-3 py-2 text-sm focus:ring-green-500 focus:border-green-500 transition w-full" placeholder="Select date">
                            </div>
                            <div class="overflow-x-auto rounded-lg border border-green-100 bg-white">
                                <table class="min-w-full divide-y divide-green-100 text-sm">
                                    <thead id="income-archive-head" class="bg-green-50"></thead>
                                    <tbody id="income-archive-body"></tbody>
                                </table>
                            </div>
                            <div id="income-archive-total" class="mt-3 font-bold text-right text-green-700 text-base"></div>
                        </div>
                        <div class="bg-gradient-to-br from-red-50 via-white to-red-100 rounded-xl shadow border border-red-200 p-5 flex flex-col">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg sm:text-xl font-bold text-red-700 flex items-center gap-2">
                                    <i class="fa-solid fa-arrow-up-long"></i>
                                    Expenditure Records
                                </h3>
                            </div>
                            <div class="flex flex-col gap-2 mb-3 w-full">
                                <label for="expenditureArchiveStartDate" class="text-red-700 text-sm font-semibold">Start Date</label>
                                <input type="date" id="expenditureArchiveStartDate" class="border border-red-300 rounded-lg px-3 py-2 text-sm focus:ring-red-500 focus:border-red-500 transition w-full" placeholder="Select date">
                                <label for="expenditureArchiveEndDate" class="text-red-700 text-sm font-semibold">End Date</label>
                                <input type="date" id="expenditureArchiveEndDate" class="border border-red-300 rounded-lg px-3 py-2 text-sm focus:ring-red-500 focus:border-red-500 transition w-full" placeholder="Select date">
                            </div>
                            <div class="overflow-x-auto rounded-lg border border-red-100 bg-white">
                                <table class="min-w-full divide-y divide-red-100 text-sm">
                                    <thead id="expenditure-archive-head" class="bg-red-50"></thead>
                                    <tbody id="expenditure-archive-body"></tbody>
                                </table>
                            </div>
                            <div id="expenditure-archive-total" class="mt-3 font-bold text-right text-red-700 text-base"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            
        </main>
    </div>

    <div id="record-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0"><div class="modal-content bg-white p-8 rounded-lg shadow-2xl max-w-md w-full transform -translate-y-10"><h2 id="modal-title" class="text-2xl font-bold mb-6 text-center">Add Record</h2><form id="record-form" class="space-y-4"><input type="hidden" id="record-type" name="type"><input type="hidden" id="record-id" name="id"><div><label for="description" class="block text-sm font-medium text-gray-700">Description</label><input type="text" id="description" name="description" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="amount" class="block text-sm font-medium text-gray-700">Amount (₹)</label><input type="number" id="amount" name="amount" required min="0.01" step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="date" class="block text-sm font-medium text-gray-700">Date</label><input type="date" id="date" name="date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="receiptNo" class="block text-sm font-medium text-gray-700">Receipt / Bill No.</label><input type="text" id="receiptNo" name="receiptNo" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="notes" class="block text-sm font-medium text-gray-700">Notes (Optional)</label><textarea id="notes" name="notes" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea></div><div class="pt-4 flex justify-end space-x-4"><button type="button" id="cancel-btn" class="bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button><button type="submit" id="submit-record-btn" class="text-white font-bold px-4 py-2 rounded-md">Submit</button></div></form></div></div>
    
    <div id="confirmation-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full transform -translate-y-10 text-center">
            <h2 id="confirmation-title" class="text-xl font-bold mb-4 text-gray-800">Confirm Action</h2>
            <p id="confirmation-message" class="text-gray-600 mb-6">Are you sure?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="bg-gray-200 px-6 py-2 rounded-md hover:bg-gray-300 font-semibold">Cancel</button>
                <button id="confirm-action-btn" class="bg-red-600 text-white font-bold px-6 py-2 rounded-md hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>

    <div id="note-details-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[100] hidden opacity-0">
        <div class="modal-content bg-white p-6 rounded-lg shadow-2xl max-w-lg w-full transform -translate-y-10">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h2 class="text-xl font-bold text-gray-800">Note Details</h2>
                <button id="close-note-modal-btn" class="text-gray-500 hover:text-red-600 text-2xl">&times;</button>
            </div>
            <div id="note-modal-body" class="text-gray-700 whitespace-pre-wrap max-h-64 overflow-y-auto"></div>
        </div>
    </div>

    <div id="team-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[100] hidden opacity-0">
        <div class="modal-content bg-white p-8 rounded-lg shadow-2xl max-w-lg w-full transform -translate-y-10">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h2 class="text-xl font-bold text-gray-800">Finance Team Members</h2>
                <button id="close-team-modal-btn" class="text-gray-500 hover:text-red-600 text-2xl">&times;</button>
            </div>
            <div id="team-modal-body" class="text-gray-700 max-h-96 overflow-y-auto"></div>
        </div>
    </div>


    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = "https://script.google.com/macros/s/AKfycbz-KB-VgYBH5hDpqMSNilbyDXeQKgkulYaB1KdyPWX9bWyvVH_Hu31P7FmwT_IlC8jEkg/exec";
            const token = localStorage.getItem("sessionToken");
            let userRole = '';
            let allIncome = [];
            let allExpenditure = [];
            let latestTeamData = [];
            let allIncomeArchive = [];
            let allExpenditureArchive = [];

            if (!token) { window.location.href = "login.html"; return; }

            const loaderOverlay = document.getElementById('loader-overlay');
            const modal = document.getElementById('record-modal');
            const modalContent = modal.querySelector('.modal-content');
            const recordForm = document.getElementById('record-form');
            const modalTitle = document.getElementById('modal-title');
            const submitBtn = document.getElementById('submit-record-btn');
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmActionBtn = document.getElementById('confirm-action-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            const noteDetailsModal = document.getElementById('note-details-modal');
            const teamModal = document.getElementById('team-modal');
            const sidebarTeamLink = document.getElementById('sidebar-team-link');
            const closeTeamModalBtn = document.getElementById('close-team-modal-btn');
            const teamModalBody = document.getElementById('team-modal-body');
            
            const motivationalQuotes = [
                { text: `"Woe to those who give less in measure and weight, Who, when they take a measure from people, take in full. But if they give by measure or by weight to them, they give less."`, source: "Qur'an (83:1-3)" },
                { text: `"O you who have believed, be persistently standing firm in justice, witnesses for Allah, even if it be against yourselves or parents and relatives."`, source: "Qur'an (4:135)" },
                { text: `"Indeed, Allah commands you to render trusts to whom they are due and when you judge between people to judge with justice."`, source: "Qur'an (4:58)" },
                { text: `"The signs of a hypocrite are three: whenever he speaks, he tells a lie; whenever he promises, he breaks his promise; and whenever he is entrusted, he betrays his trust."`, source: "Hadith (Bukhari)" }
            ];

            const sidebar = document.getElementById('sidebar');
            const menuToggleBtn = document.getElementById('menu-toggle-btn');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const body = document.body;

            const toggleSidebar = () => {
                // This correctly toggles the Tailwind CSS classes to slide the menu in and out
                sidebar.classList.toggle('translate-x-full');
                
                // Also toggle the overlay and body scroll
                sidebarOverlay.classList.toggle('hidden');
                body.classList.toggle('body-no-scroll');
            };

            if (menuToggleBtn) menuToggleBtn.addEventListener('click', toggleSidebar);
            if (sidebarOverlay) sidebarOverlay.addEventListener('click', toggleSidebar);
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', () => { if (window.innerWidth < 1024) toggleSidebar(); });
            });
            const sections = document.querySelectorAll('.scroll-target');
            const navLinks = document.querySelectorAll('#sidebar-nav a');
            
            const activateLinkOnScroll = () => {
                let current = '';
                sections.forEach(section => {
                    const sectionTop = section.offsetTop;
                    if (pageYOffset >= sectionTop - 100) {
                        current = section.getAttribute('id');
                    }
                });
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if(link.hash === '#' + current) {
                        link.classList.add('active');
                    }
                });
            };
            window.addEventListener('scroll', activateLinkOnScroll);

            const showLoader = (text = 'Processing...') => { loaderOverlay.querySelector('p.loader-text').textContent = text; loaderOverlay.classList.remove('hidden'); };
            const hideLoader = () => loaderOverlay.classList.add('hidden');
            const showToast = (message, isError = false) => { 
                Toastify({ 
                    text: message, 
                    duration: 3000, 
                    close: true, 
                    gravity: "top", 
                    position: "right", 
                    style: { 
                        background: isError ? "linear-gradient(to right, #ef4444, #b91c1c)" : "linear-gradient(to right, #22c55e, #15803d)" 
                    }
                }).showToast(); 
            };
            const formatCurrency = (value) => { try { const num = parseFloat(value) || 0; return `₹${new Intl.NumberFormat('en-IN').format(num.toFixed(2))}`; } catch (e) { return "₹0.00"; } };
            const openModal = (type, record = null) => {
                recordForm.reset();
                document.getElementById('record-type').value = type;
                document.getElementById('date').valueAsDate = new Date();
                document.getElementById('record-id').value = '';
                const isEdit = record !== null;
                const typeText = type.charAt(0).toUpperCase() + type.slice(1);
                modalTitle.textContent = isEdit ? `Edit ${typeText}` : `Add New ${typeText}`;
                submitBtn.textContent = isEdit ? 'Save Changes' : `Add ${typeText}`;
                if (type === 'income') {
                    modalTitle.classList.add('text-green-700');
                    modalTitle.classList.remove('text-red-700');
                    submitBtn.classList.add('bg-green-600');
                    submitBtn.classList.remove('bg-red-600');
                } else {
                    modalTitle.classList.add('text-red-700');
                    modalTitle.classList.remove('text-green-700');
                    submitBtn.classList.add('bg-red-600');
                    submitBtn.classList.remove('bg-green-600');
                }
                if (isEdit) {
                    document.getElementById('record-id').value = record[0];
                    document.getElementById('description').value = record[2];
                    document.getElementById('amount').value = record[3];
                    document.getElementById('date').value = new Date(record[4]).toISOString().split('T')[0];
                    document.getElementById('receiptNo').value = record[5];
                    document.getElementById('notes').value = record[6] || '';
                }
                modal.classList.remove('hidden');
                setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('.modal-content').classList.remove('-translate-y-10'); }, 10);
            };
            const closeModal = () => { modal.classList.add('opacity-0'); modal.querySelector('.modal-content').classList.add('-translate-y-10'); setTimeout(() => modal.classList.add('hidden'), 300); };
            let confirmCallback = null;
            const openConfirmationModal = (title, message, onConfirm, actionColor = 'red') => {
                document.getElementById('confirmation-title').textContent = title;
                document.getElementById('confirmation-message').textContent = message;
                confirmCallback = onConfirm;
                const confirmBtn = document.getElementById('confirm-action-btn');
                confirmBtn.className = `font-bold px-6 py-2 rounded-md text-white`;
                if(actionColor === 'red') { confirmBtn.classList.add('bg-red-600', 'hover:bg-red-700'); } else { confirmBtn.classList.add('bg-blue-600', 'hover:bg-blue-700'); }
                confirmationModal.classList.remove('hidden');
                setTimeout(() => { confirmationModal.classList.remove('opacity-0'); confirmationModal.querySelector('.modal-content').classList.remove('-translate-y-10'); }, 10);
            };
            const closeConfirmationModal = () => { confirmationModal.classList.add('opacity-0'); confirmationModal.querySelector('.modal-content').classList.add('-translate-y-10'); setTimeout(() => confirmationModal.classList.add('hidden'), 300); confirmCallback = null; };
            const postData = (payload, callback) => {
                showLoader();
                fetch(API_URL, { method: 'POST', redirect: 'follow', body: JSON.stringify({ ...payload, token }), headers: { "Content-Type": "text/plain;charset=utf-8" } })
                .then(res => res.json()).then(data => { if (data.status === 'error') throw new Error(data.message); if (callback) callback(data); })
                .catch(err => { showToast(err.message, true); if (err.message.includes("Unauthorized")) { localStorage.removeItem("sessionToken"); window.location.href = "login.html"; } })
                .finally(hideLoader);
            };
            const renderDashboard = (data) => {
                allIncome = data.income || [];
                allExpenditure = data.expenditure || [];
                const balanceBf = data.balanceBf || 0;
                latestTeamData = data.financeTeam || []; // <-- Add this line
                renderFinanceTeam(latestTeamData);
                const user = data.userProfile;
                if (user) { userRole = user.role; document.getElementById('userName').textContent = `Welcome, ${user.fullName}`; document.getElementById('userRole').textContent = user.role; if (user.role === 'Manager') { document.querySelectorAll('.manager-only').forEach(el => el.style.display = 'inline-block'); } }
                renderTable(allIncome, document.getElementById('income-table-body'), 'income');
                renderTable(allExpenditure, document.getElementById('expenditure-table-body'), 'expenditure');
                const incomeRecords = allIncome.slice(1);
                const expenditureRecords = allExpenditure.slice(1);
                const totalIncome = incomeRecords.reduce((sum, row) => sum + parseFloat(row[3] || 0), 0);
                const totalExpenditure = expenditureRecords.reduce((sum, row) => sum + parseFloat(row[3] || 0), 0);
                const netFlow = totalIncome - totalExpenditure;
                const finalBalance = balanceBf + netFlow;
                document.getElementById('balance-bf').textContent = formatCurrency(balanceBf);
                document.getElementById('total-income').textContent = formatCurrency(totalIncome);
                document.getElementById('total-expenditure').textContent = formatCurrency(totalExpenditure);
                document.getElementById('net-flow').textContent = formatCurrency(netFlow);
                document.getElementById('total-balance').textContent = formatCurrency(finalBalance);
            };
            const renderTable = (data, tbody, type) => {
                tbody.innerHTML = '';
                if (!data || data.length <= 1) { tbody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-4">No records found.</td></tr>`; return; }
                const rows = data.slice(1);
                rows.forEach(row => {
                    let noteHtml = '';
                    if (row[6] && row[6].trim() !== '') {
                        noteHtml = `<i class="fa-solid fa-comment-dots note-icon ml-2" data-note="${encodeURIComponent(row[6])}"></i>`;
                    }
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-800 flex items-center">${row[2]} ${noteHtml}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${formatCurrency(row[3])}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${new Date(row[4]).toLocaleDateString()}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${row[1]}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 space-x-2 manager-only">
                            <button class="edit-btn" data-id="${row[0]}" data-type="${type}" title="Edit"><i class="fa-solid fa-pencil text-blue-600 hover:text-blue-800"></i></button>
                            <button class="delete-btn" data-id="${row[0]}" data-type="${type}" title="Delete"><i class="fa-solid fa-trash text-red-600 hover:text-red-800"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                if (userRole === 'Manager') { tbody.querySelectorAll('.manager-only').forEach(el => el.style.display = 'table-cell'); }
            };
            const renderFinanceTeam = (teamData) => {
                const container = document.getElementById('team-modal-body');
                container.innerHTML = '';
                if (!teamData || teamData.length <= 1) {
                    container.innerHTML = `<p class="text-center text-gray-500 py-4">No team data found.</p>`;
                    return;
                }
                const headers = teamData[0];
                const teamRows = teamData.slice(1);
                teamRows.forEach(row => {
                    const fullName = row[headers.indexOf("FullName")];
                    const email = row[headers.indexOf("Email")];
                    const role = row[headers.indexOf("Role")];
                    const accordionItem = document.createElement('div');
                    accordionItem.className = 'border rounded-lg overflow-hidden mb-2';
                    accordionItem.innerHTML = `
                        <button class="accordion-toggle-team w-full p-4 flex justify-between items-center text-left hover:bg-gray-50 transition">
                            <span class="font-semibold text-gray-800">${fullName}</span>
                            <i class="fa-solid fa-chevron-down text-gray-500 transition-transform duration-300"></i>
                        </button>
                        <div class="accordion-panel-team overflow-hidden" style="max-height: 0; transition: max-height 0.4s ease-out;">
                            <div class="p-4 border-t bg-gray-50 text-sm">
                                <p class="mb-2"><strong class="text-gray-600">Email:</strong> ${email}</p>
                                <p><strong class="text-gray-600">Role:</strong> <span class="font-medium text-blue-700">${role}</span></p>
                            </div>
                        </div>
                    `;
                    container.appendChild(accordionItem);
                });
                container.querySelectorAll('.accordion-toggle-team').forEach(button => {
                    button.addEventListener('click', () => {
                        const panel = button.nextElementSibling;
                        const icon = button.querySelector('i');
                        if (panel.style.maxHeight === '0px' || !panel.style.maxHeight) {
                            panel.style.maxHeight = panel.scrollHeight + 'px';
                            icon.classList.add('rotate-180');
                        } else {
                            panel.style.maxHeight = '0';
                            icon.classList.remove('rotate-180');
                        }
                    });
                });
            };
            const fetchFinanceData = () => { showLoader('Loading Finance Data...'); postData({ action: 'getFinanceData' }, (data) => { renderDashboard(data); hideLoader(); }); };
            document.getElementById('logoutButton').addEventListener('click', () => { showLoader('Logging out...'); localStorage.removeItem('sessionToken'); window.location.href = 'login.html'; });
            document.getElementById('add-income-btn').addEventListener('click', () => openModal('income'));
            document.getElementById('add-expenditure-btn').addEventListener('click', () => openModal('expenditure'));
            document.getElementById('cancel-btn').addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            recordForm.addEventListener('submit', (e) => { e.preventDefault(); const formData = new FormData(recordForm); const recordData = Object.fromEntries(formData.entries()); const action = recordData.id ? 'updateRecord' : 'addRecord'; postData({ action: action, data: recordData }, (response) => { showToast(response.message); closeModal(); fetchFinanceData(); }); });
            document.querySelectorAll('#income-table-body, #expenditure-table-body').forEach(tbody => {
                tbody.addEventListener('click', (e) => {
                    const target = e.target;
                    const button = target.closest('button');
                    if (target.classList.contains('note-icon')) {
                        const note = decodeURIComponent(target.dataset.note);
                        document.getElementById('note-modal_body').textContent = note;
                        noteDetailsModal.classList.remove('hidden');
                        setTimeout(() => { noteDetailsModal.classList.remove('opacity-0'); noteDetailsModal.querySelector('.modal-content').classList.remove('-translate-y-10'); }, 10);
                    } else if (button) {
                        const id = button.dataset.id;
                        const type = button.dataset.type;
                        const sourceData = type === 'income' ? allIncome : allExpenditure;
                        const record = sourceData.slice(1).find(row => row[0] === id);
                        if (!record) return;
                        if (button.classList.contains('edit-btn')) { openModal(type, record); }
                        else if (button.classList.contains('delete-btn')) { openConfirmationModal('Confirm Deletion', `Are you sure you want to delete this ${type} record? This cannot be undone.`, () => { postData({ action: 'deleteRecord', data: { id, type } }, (response) => { showToast(response.message); fetchFinanceData(); }); }, 'red'); }
                    }
                });
            });
            document.getElementById('close-note-modal-btn').addEventListener('click', () => { noteDetailsModal.classList.add('opacity-0'); noteDetailsModal.querySelector('.modal-content').classList.add('-translate-y-10'); setTimeout(() => noteDetailsModal.classList.add('hidden'), 300); });
            noteDetailsModal.addEventListener('click', (e) => { if (e.target === noteDetailsModal) document.getElementById('close-note-modal-btn').click(); });
            document.getElementById('send-report-btn').addEventListener('click', () => { openConfirmationModal('Send Finance Report', 'Are you sure you want to send the weekly finance report now?', () => { postData({ action: 'sendFinanceReport' }, (response) => showToast(response.message)); }, 'blue'); });
            document.getElementById('close-ledger-btn').addEventListener('click', () => { openConfirmationModal('Confirm Ledger Close', 'This will finalize the current balance, archive all transactions, and start a new period. This action cannot be undone. Are you sure?', () => { postData({ action: 'closeLedger' }, (response) => { showToast(response.message); setTimeout(() => { location.reload(); }, 2000); }); }, 'red'); });
            confirmActionBtn.addEventListener('click', () => { if (typeof confirmCallback === 'function') { confirmCallback(); } closeConfirmationModal(); });
            confirmCancelBtn.addEventListener('click', closeConfirmationModal);
            confirmationModal.addEventListener('click', (e) => { if (e.target === confirmationModal) closeConfirmationModal(); });
            document.getElementById('download-pdf-btn').addEventListener('click', () => {
                showLoader('Generating PDF...');
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                // 333333333333333333333333333333
                const instituteLogoBase64 = "";
                let serialCounter = localStorage.getItem('reportSerialCounter') || 0;
                serialCounter = parseInt(serialCounter, 10) + 1;
                const formattedSerial = `IIE/FR/${String(serialCounter).padStart(3, '0')}`;
                const pageHeight = doc.internal.pageSize.getHeight();
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 10;
                const headerHeight = 65;
                const footerHeight = 50;
                const addPageTemplate = (data) => {
                    doc.addImage(instituteLogoBase64, 'PNG', margin + 5, margin + 5, 25, 25);
                    let textY = margin + 12;
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(18);
                    doc.setTextColor('#1e3a8a');
                    doc.text("Institute of Islamic Education", pageWidth / 2, textY, { align: 'center' });
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    textY += 6;
                    doc.text("Finance Department - Financial Report", pageWidth / 2, textY, { align: 'center' });
                    doc.setFontSize(9);
                    doc.setTextColor(100);
                    textY += 5;
                    const contactInfo = "Address: Chanthan Check Pora, Beerwah, 193411  |  Phone: +91 94197 37927";
                    doc.text(contactInfo, pageWidth / 2, textY, { align: 'center' });
                    const separatorY = textY + 8;
                    doc.setDrawColor(180, 180, 180);
                    doc.line(margin, separatorY, pageWidth - margin, separatorY);
                    let metadataY = separatorY + 8;
                    doc.setFontSize(9);
                    doc.setTextColor(100);
                    doc.text(formattedSerial, margin, metadataY);
                    const dateText = `Generated on: ${new Date().toLocaleDateString('en-GB')}`;
                    const dateTextWidth = doc.getTextWidth(dateText);
                    doc.text(dateText, pageWidth - margin - dateTextWidth, metadataY);
                    doc.setDrawColor(0, 0, 0);
                    doc.rect(margin, margin, pageWidth - 2 * margin, pageHeight - 2 * margin);
                    const footerLineY = pageHeight - margin - 35;
                    doc.setDrawColor(180, 180, 180);
                    doc.line(margin, footerLineY, pageWidth - margin, footerLineY);
                    const disclaimerText = "This is a machine-generated report. It is not valid without an in-person seal and signature.";
                    doc.setFont("helvetica", "italic");
                    doc.setFontSize(7);
                    doc.setTextColor(150);
                    const disclaimerWidth = doc.getTextWidth(disclaimerText);
                    doc.text(disclaimerText, (pageWidth - disclaimerWidth) / 2, footerLineY + 8);
                    doc.setFont("helvetica", "normal");
                    const pageNumberText = `Page ${data.pageNumber} of ${doc.internal.getNumberOfPages()}`;
                    doc.setFontSize(8);
                    doc.setTextColor(100);
                    const pageNumWidth = doc.getTextWidth(pageNumberText);
                    doc.text(pageNumberText, (pageWidth - pageNumWidth) / 2, footerLineY + 14);
                    const signatureY = pageHeight - margin - 5;
                    doc.setFontSize(10);
                    doc.text("Institute Seal", margin + 5, signatureY);
                    const signatureText = "Signature by Finance Manager";
                    const signatureTextWidth = doc.getTextWidth(signatureText);
                    doc.text(signatureText, pageWidth - margin - 5 - signatureTextWidth, signatureY);
                };
                const mapDataToTable = (data) => {
                    if (!data || data.length <= 1) return [];
                    return data.slice(1).map((row, index) => [ index + 1, String(row[2] || ''), formatCurrency(row[3]), !isNaN(new Date(row[4])) ? new Date(row[4]).toLocaleDateString() : 'N/A', row[5] || '' ]);
                };
                const incomeBody = mapDataToTable(allIncome);
                const expenditureBody = mapDataToTable(allExpenditure);
                const tableStyles = {
                    styles: { overflow: 'linebreak', lineColor: [200, 200, 200], lineWidth: 0.1 },
                    margin: { top: headerHeight, bottom: footerHeight },
                    didDrawPage: addPageTemplate
                };
                const columnWidths = {
                    0: { cellWidth: 15 }, 1: { cellWidth: 55 }, 2: { cellWidth: 55 }, 3: { cellWidth: 25 }, 4: { cellWidth: 'auto' }
                };
                let tableStartY = headerHeight;
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(22, 163, 74);
                doc.text("Income Records", pageWidth / 2, tableStartY, { align: 'center' });
                tableStartY += 6;
                doc.autoTable({
                    head: [['SR', 'Description', 'Amount', 'Date', 'Receipt No.']],
                    body: incomeBody,
                    startY: tableStartY,
                    theme: 'grid',
                    columnStyles: columnWidths,
                    bodyStyles: { textColor: [16, 122, 53] },
                    ...tableStyles
                });
                tableStartY = doc.autoTable.previous.finalY + 15;
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(220, 38, 38);
                doc.text("Expenditure Records", pageWidth / 2, tableStartY, { align: 'center' });
                tableStartY += 6;
                doc.autoTable({
                    head: [['SR', 'Description', 'Amount', 'Date', 'Bill No.']],
                    body: expenditureBody,
                    startY: tableStartY,
                    theme: 'grid',
                    columnStyles: columnWidths,
                    bodyStyles: { textColor: [192, 28, 28] },
                    ...tableStyles
                });
                const lastContentY = doc.autoTable.previous.finalY;
                const summaryHeight = 40;
                let summaryStartY = pageHeight - footerHeight - summaryHeight;
                if (lastContentY > summaryStartY) {
                    doc.addPage();
                }
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(0, 0, 0);
                doc.text("Financial Summary:", margin + 4, summaryStartY - 5);
                doc.autoTable({
                    body: [
                        ['Balance B/F:', document.getElementById('balance-bf').textContent],
                        ['Total Income:', document.getElementById('total-income').textContent],
                        ['Total Expenditure:', document.getElementById('total-expenditure').textContent],
                        [{ content: 'Final Balance:', styles: { fontStyle: 'bold' } }, { content: document.getElementById('total-balance').textContent, styles: { fontStyle: 'bold' } }]
                    ],
                    startY: summaryStartY,
                    theme: 'plain',
                    ...tableStyles
                });
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    const disclaimerText = "This is a machine-generated report. It is not valid without an in-person seal and signature.";
                    doc.setFont("helvetica", "italic");
                    doc.setFontSize(7);
                    doc.setTextColor(150);
                    const disclaimerWidth = doc.getTextWidth(disclaimerText);
                    doc.text(disclaimerText, (pageWidth - disclaimerWidth) / 2, pageHeight - margin - 27);
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(8);
                    doc.setTextColor(100);
                    const pageNumberText = `Page ${i} of ${totalPages}`;
                    const pageNumWidth = doc.getTextWidth(pageNumberText);
                    doc.text(pageNumberText, (pageWidth - pageNumWidth) / 2, pageHeight - margin - 21);
                }
                localStorage.setItem('reportSerialCounter', serialCounter);
                doc.save(`IIE-FR-${String(serialCounter).padStart(3, '0')}.pdf`);
                hideLoader();
            });
            // =======================================================
            // --- NEW NOTIFICATION FUNCTIONS (Paste the entire block)---
            // =======================================================
            
            function updateUnreadCount(notifications) {
                const count = notifications.filter(n => n.status !== 'Read').length;
                const sidebarBadge = document.getElementById('sidebar-unread-count');
                const mobileBadge = document.getElementById('mobile-unread-count');
                if (count > 0) {
                    sidebarBadge.textContent = count;
                    sidebarBadge.classList.remove('hidden');
                    mobileBadge.textContent = count;
                    mobileBadge.classList.remove('hidden');
                } else {
                    sidebarBadge.classList.add('hidden');
                    mobileBadge.classList.add('hidden');
                }
            }

            const bellBtn = document.getElementById('mobile-bell-btn');
            const dropdown = document.getElementById('notification-dropdown');

            // Toggle dropdown on bell click (do NOT scroll to notifications here)
            if (bellBtn) {
                bellBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dropdown.classList.toggle('hidden');
                });
                document.addEventListener('click', () => {
                    dropdown.classList.add('hidden');
                });
                dropdown.addEventListener('click', (e) => e.stopPropagation());
            }

            // When you click a notification in the dropdown, scroll to notifications section
            function renderDropdownNotifications(notifications) {
                const dropdownList = document.getElementById('dropdown-notification-list');
                if (!dropdownList) return;
                dropdownList.innerHTML = '';
                if (!notifications || notifications.length === 0) {
                    dropdownList.innerHTML = '<p class="text-gray-500 p-4">No notifications.</p>';
                    return;
                }
                notifications.slice(0, 10).forEach(notif => {
                    const isRead = notif.status === 'Read';
                    const notifItem = document.createElement('div');
                    notifItem.className = `p-3 border-b last:border-b-0 cursor-pointer hover:bg-gray-50 ${isRead ? 'bg-gray-50' : 'bg-white'}`;
                    notifItem.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-gray-800">${notif.subject}</span>
                            <span class="text-xs text-gray-500">${new Date(notif.timestamp).toLocaleDateString()}</span>
                        </div>
                        <div class="text-sm text-gray-600 mt-1">${notif.body}</div>
                        ${!isRead ? `<span class="inline-block mt-2 px-2 py-0.5 text-xs font-semibold bg-blue-100 text-blue-700 rounded-full">New</span>` : ''}
                    `;
                    notifItem.addEventListener('click', () => {
                        dropdown.classList.add('hidden');
                        document.getElementById('notifications').scrollIntoView({ behavior: 'smooth' });
                    });
                    dropdownList.appendChild(notifItem);
                });
            }

            // Update fetchUserNotifications to also update dropdown
            function fetchUserNotifications() {
                const userNotificationList = document.getElementById('user-notification-list');
                const bellIcon = document.querySelector('#mobile-bell-btn i');
                const dropdownList = document.getElementById('dropdown-notification-list');
                // Show loader and animate bell
                if (userNotificationList) {
                    userNotificationList.innerHTML = `
                        <div class="notification-loader">
                            <div class="cube">
                                <div class="cube-face front"></div>
                                <div class="cube-face back"></div>
                                <div class="cube-face right"></div>
                                <div class="cube-face left"></div>
                                <div class="cube-face top"></div>
                                <div class="cube-face bottom"></div>
                            </div>
                            <div class="mt-4 text-blue-700 font-semibold">Loading notifications...</div>
                        </div>
                    `;
                }
                if (dropdownList) dropdownList.innerHTML = '<p class="text-gray-500 p-4">Loading...</p>';
                if (bellIcon) bellIcon.classList.add('bell-animate');
                fetch(`${API_URL}?action=getNotifications&token=${token}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            renderNotifications(data.notifications);
                            renderDropdownNotifications(data.notifications);
                            updateUnreadCount(data.notifications);
                        } else throw new Error(data.message);
                    })
                    .catch(err => {
                        if (userNotificationList) userNotificationList.innerHTML = '<p class="text-red-500">Could not load notifications.</p>';
                        if (dropdownList) dropdownList.innerHTML = '<p class="text-red-500 p-4">Could not load notifications.</p>';
                        console.error("Error fetching notifications:", err);
                    })
                    .finally(() => {
                        if (bellIcon) bellIcon.classList.remove('bell-animate');
                    });
            }

            function renderNotifications(notifications) {
                const userNotificationList = document.getElementById('user-notification-list');
                userNotificationList.innerHTML = '';
                if (!notifications || notifications.length === 0) {
                    userNotificationList.innerHTML = '<p class="text-gray-500">You have no notifications.</p>';
                    return;
                }
                notifications.forEach((notif, idx) => {
                    const isRead = notif.status === 'Read';
                    const notifEl = document.createElement('div');
                    notifEl.className = `p-4 border-l-4 rounded-md mb-6 shadow-sm ${isRead ? 'border-gray-200 bg-gray-50' : 'border-blue-500 bg-white'}`;
                    notifEl.innerHTML = `
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-gray-800">${notif.subject}</h3>
                            <span class="text-xs text-gray-500">${new Date(notif.timestamp).toLocaleString()}</span>
                        </div>
                        <p class="mt-2 text-gray-600">${notif.body}</p>
                        <div class="replies-container mt-3 space-y-2">
                            ${notif.reply ? `<div class="text-sm p-2 bg-gray-200 rounded-md whitespace-pre-wrap">${notif.reply}</div>` : ''}
                        </div>
                        ${isRead 
                            ? `<span class="inline-block mt-2 px-3 py-1 text-xs font-semibold bg-green-100 text-green-700 rounded-full">Message Seen</span>` 
                            : `<button class="mark-read-btn mt-2 px-3 py-1 text-xs font-semibold bg-blue-100 text-blue-700 rounded-full">Mark as Read</button>`
                        }
                        <form class="reply-form mt-4 space-y-2" data-message-id="${notif.messageId}">
                            <textarea rows="2" placeholder="Type your reply..." required class="block w-full border-gray-300 rounded-md shadow-sm text-sm p-2"></textarea>
                            <button type="submit" class="bg-blue-600 text-white font-semibold py-1 px-3 text-sm rounded-md hover:bg-blue-700">Send Reply</button>
                        </form>
                        ${idx < notifications.length - 1 ? '<hr class="my-6 border-gray-300">' : ''}
                    `;
                    userNotificationList.appendChild(notifEl);

                    // Mark as Read button handler
                    if (!isRead) {
                        const markReadBtn = notifEl.querySelector('.mark-read-btn');
                        markReadBtn.addEventListener('click', () => {
                            showLoader('Marking as read...');
                            postData({ action: 'markAsRead', messageId: notif.messageId }, (response) => {
                                hideLoader();
                                userNotificationList.innerHTML = `
                                    <div class="notification-loader">
                                        <div class="cube">
                                            <div class="cube-face front"></div>
                                            <div class="cube-face back"></div>
                                            <div class="cube-face right"></div>
                                            <div class="cube-face left"></div>
                                            <div class="cube-face top"></div>
                                            <div class="cube-face bottom"></div>
                                        </div>
                                        <div class="mt-4 text-blue-700 font-semibold">Loading notifications...</div>
                                    </div>
                                `;
                                fetchUserNotifications();
                            });
                        });
                    }

                    // Reply form handler
                    const replyForm = notifEl.querySelector('.reply-form');
                    replyForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        showLoader('Sending reply...');
                        const replyText = replyForm.querySelector('textarea').value;
                        // If not already read, mark as read first, then send reply
                        if (!isRead) {
                            postData({ action: 'markAsRead', messageId: notif.messageId }, (markResponse) => {
                                postData({ action: 'replyToNotification', replyData: { messageId: notif.messageId, replyText } }, (response) => {
                                    hideLoader();
                                    userNotificationList.innerHTML = `
                                        <div class="notification-loader">
                                            <div class="cube">
                                                <div class="cube-face front"></div>
                                                <div class="cube-face back"></div>
                                                <div class="cube-face right"></div>
                                                <div class="cube-face left"></div>
                                                <div class="cube-face top"></div>
                                                <div class="cube-face bottom"></div>
                                            </div>
                                            <div class="mt-4 text-blue-700 font-semibold">Loading notifications...</div>
                                        </div>
                                    `;
                                    fetchUserNotifications();
                                });
                            });
                        } else {
                            postData({ action: 'replyToNotification', replyData: { messageId: notif.messageId, replyText } }, (response) => {
                                hideLoader();
                                userNotificationList.innerHTML = `
                                    <div class="notification-loader">
                                        <div class="cube">
                                            <div class="cube-face front"></div>
                                            <div class="cube-face back"></div>
                                            <div class="cube-face right"></div>
                                            <div class="cube-face left"></div>
                                            <div class="cube-face top"></div>
                                            <div class="cube-face bottom"></div>
                                        </div>
                                        <div class="mt-4 text-blue-700 font-semibold">Loading notifications...</div>
                                    </div>
                                `;
                                fetchUserNotifications();
                            });
                        }
                    });
                });
            };
            const fetchFinanceDataAndNotifications = () => {
                showLoader('Loading Finance Data...');
                postData({ action: 'getFinanceData' }, (data) => {
                    renderDashboard(data);
                    hideLoader();

                    // Show notification loader immediately after full-page loader hides
                    const userNotificationList = document.getElementById('user-notification-list');
                    if (userNotificationList) {
                        userNotificationList.innerHTML = `
                            <div class="notification-loader">
                                <div class="cube">
                                    <div class="cube-face front"></div>
                                    <div class="cube-face back"></div>
                                    <div class="cube-face right"></div>
                                    <div class="cube-face left"></div>
                                    <div class="cube-face top"></div>
                                    <div class="cube-face bottom"></div>
                                </div>
                                <div class="mt-4 text-blue-700 font-semibold">Loading notifications...</div>
                            </div>
                        `;
                    }
                    // Now fetch notifications (will replace loader when done)
                    setTimeout(fetchUserNotifications, 0); // Ensures loader is rendered before fetch starts
                });

                const quote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
                document.getElementById('loader-motivation-text').textContent = `${quote.text} - ${quote.source}`;
            };

            sidebarTeamLink.addEventListener('click', () => {
                renderFinanceTeam(latestTeamData); // <-- Add this line
                teamModal.classList.remove('hidden');
                setTimeout(() => {
                    teamModal.classList.remove('opacity-0');
                    teamModal.querySelector('.modal-content').classList.remove('-translate-y-10');
                }, 10);
            });
            document.getElementById('close-team-modal-btn').addEventListener('click', () => { teamModal.classList.add('opacity-0'); teamModal.querySelector('.modal-content').classList.add('-translate-y-10'); setTimeout(() => teamModal.classList.add('hidden'), 300); });
            teamModal.addEventListener('click', (e) => { if (e.target === teamModal) closeTeamModalBtn.click(); });
            fetchFinanceDataAndNotifications();

            function filterArchiveRows(data, type) {
                if (!data || data.length < 2) return [];
                const headers = data[0];
                // Find the "Date" column (should be index 6 for archive: ["Date Archived", "Archived By", ...original columns])
                let dateIndex = headers.indexOf("Date");
                if (dateIndex === -1) dateIndex = headers.findIndex(h => h.toLowerCase().includes("date"));
                let start = document.getElementById(type + "ArchiveStartDate").value;
                let end = document.getElementById(type + "ArchiveEndDate").value;
                let rows = data.slice(1);
                if (start) {
                    const startDate = new Date(start);
                    rows = rows.filter(row => new Date(row[dateIndex]) >= startDate);
                }
                if (end) {
                    const endDate = new Date(end);
                    rows = rows.filter(row => new Date(row[dateIndex]) <= endDate);
                }
                return rows;
            }

            function renderArchiveTable(data, headId, bodyId, totalId, type) {
                const head = document.getElementById(headId);
                const body = document.getElementById(bodyId);
                const totalDiv = document.getElementById(totalId);
                head.innerHTML = "";
                body.innerHTML = "";
                totalDiv.textContent = "";
                if (!data || data.length < 2) {
                    body.innerHTML = `<tr><td colspan="8" class="text-center text-gray-500 py-4">No archived records.</td></tr>`;
                    return;
                }
                const headers = data[0];
                head.innerHTML = `<tr>${headers.map(h => `<th class="px-4 py-2">${h}</th>`).join("")}</tr>`;
                const rows = filterArchiveRows(data, type);
                let total = 0;
                const amountIndex = headers.indexOf("Amount");
                rows.forEach(row => { total += parseFloat(row[amountIndex]) || 0; });
                rows.forEach(row => {
                    body.innerHTML += `<tr>${row.map(cell => `<td class="px-4 py-2">${cell instanceof Date ? cell.toLocaleDateString() : cell}</td>`).join("")}</tr>`;
                });
                totalDiv.textContent = `Total: ₹${total.toFixed(2)}`;
            }

            function updateArchiveTables() {
                renderArchiveTable(allIncomeArchive, "income-archive-head", "income-archive-body", "income-archive-total", "income");
                renderArchiveTable(allExpenditureArchive, "expenditure-archive-head", "expenditure-archive-body", "expenditure-archive-total", "expenditure");
            }

            document.getElementById("incomeArchiveStartDate").addEventListener("change", updateArchiveTables);
            document.getElementById("incomeArchiveEndDate").addEventListener("change", updateArchiveTables);
            document.getElementById("expenditureArchiveStartDate").addEventListener("change", updateArchiveTables);
            document.getElementById("expenditureArchiveEndDate").addEventListener("change", updateArchiveTables);

            function fetchArchiveRecords() {
                postData({ action: "getArchiveRecords" }, (data) => {
                    if (data.status === "success") {
                        allIncomeArchive = data.incomeArchive || [];
                        allExpenditureArchive = data.expenditureArchive || [];
                        updateArchiveTables();
                    }
                });
            }

            document.getElementById("download-archive-pdf-btn").addEventListener("click", () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ format: "a4", orientation: "landscape" });

                let y = 15;
                doc.setFontSize(18);
                doc.setFont("times", "bold");
                doc.text("Institute of Islamic Education - Finance Records", 14, y);
                y += 10;

                // Filtered Income Archive
                doc.setFontSize(14);
                doc.setFont("times", "normal");
                doc.setTextColor(22, 163, 74);
                doc.text("Income Records", 14, y);
                y += 6;
                const filteredIncome = filterArchiveRows(allIncomeArchive, "income");
                if (filteredIncome.length > 0) {
                    doc.autoTable({
                        head: [allIncomeArchive[0]],
                        body: filteredIncome,
                        startY: y,
                        theme: 'striped',
                        styles: { fontSize: 8, cellPadding: 2 },
                        headStyles: { fillColor: [28, 58, 138] },
                        tableWidth: 'auto'
                    });
                    y = doc.lastAutoTable.finalY + 10;
                    let total = 0;
                    const amountIndex = allIncomeArchive[0].indexOf("Amount");
                    filteredIncome.forEach(row => { total += parseFloat(row[amountIndex]) || 0; });
                    doc.setFont("times", "normal");
                    doc.setFontSize(14);
                    doc.setTextColor(22, 163, 74);
                    doc.text("Total: Rs. " + total.toFixed(2), 14, y);
                    y += 8;
                } else {
                    doc.setFontSize(12);
                    doc.setTextColor(150, 0, 0);
                    doc.text("No records found for selected dates.", 14, y);
                    y += 8;
                }

                // Filtered Expenditure Archive
                doc.setFontSize(14);
                doc.setFont("times", "normal");
                doc.setTextColor(220, 38, 38);
                doc.text("Expenditure Records", 14, y);
                y += 6;
                const filteredExpenditure = filterArchiveRows(allExpenditureArchive, "expenditure");
                if (filteredExpenditure.length > 0) {
                    doc.autoTable({
                        head: [allExpenditureArchive[0]],
                        body: filteredExpenditure,
                        startY: y,
                        theme: 'striped',
                        styles: { fontSize: 8, cellPadding: 2 },
                        headStyles: { fillColor: [192, 28, 28] },
                        tableWidth: 'auto'
                    });
                    y = doc.lastAutoTable.finalY + 10;
                    let total = 0;
                    const amountIndex = allExpenditureArchive[0].indexOf("Amount");
                    filteredExpenditure.forEach(row => { total += parseFloat(row[amountIndex]) || 0; });
                    doc.setFont("times", "normal");
                    doc.setFontSize(14);
                    doc.setTextColor(220, 38, 38);
                    doc.text("Total: Rs. " + total.toFixed(2), 14, y);
                } else {
                    doc.setFontSize(12);
                    doc.setTextColor(150, 0, 0);
                    doc.text("No records found for selected dates.", 14, y);
                }

                doc.save("filtered-archived-records.pdf");
            });

            // Call this after login and finance data fetch
            fetchArchiveRecords();
        });
    </script>
</body>
</html>