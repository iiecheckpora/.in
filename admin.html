<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Mirza:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; }
        .body-no-scroll { overflow: hidden; }
        .toastify { font-family: 'Inter', sans-serif; border-radius: 0.5rem; }
        .sortable-header { cursor: pointer; }
        .sortable-header:hover { background-color: #f9fafb; }
        .motivation-card {
            background: linear-gradient(135deg, #16a34a 0%, #1e3a8a 100%);
        }
        [lang="ar"] { font-family: 'Mirza', serif; }
        .scroll-target { scroll-margin-top: 80px; }

        /* Sidebar Styles */
        #sidebar { 
            transition: transform 0.3s ease-in-out; 
            height: 100vh; /* Fallback for older browsers */
            height: 100dvh; /* Fix for mobile browser UI */
        }
        #sidebar.open { 
            transform: translateX(0); 
        }
        .sidebar-link { 
            transition: background-color 0.2s, color 0.2s; 
        }
        .sidebar-link:hover { 
            background-color: #3b82f6; 
            color: white; 
        }
        .sidebar-link.active { 
            background-color: #1e3a8a; 
            color: white; 
            font-weight: 600; 
        }

        /* Loader Styles */
        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #ffffff; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
            transition: opacity 0.75s ease-in-out, visibility 0.75s;
            opacity: 1; visibility: visible; text-align: center;
        }
        #loader-overlay.hidden { opacity: 0; visibility: hidden; }
        .loader-logo { width: 80px; height: 80px; animation: pulse-zoom 2s infinite cubic-bezier(0.4, 0, 0.6, 1); }
        .loader-text { margin-top: 1rem; font-size: 1.125rem; font-weight: 600; color: #1e3a8a; animation: text-fade 2s infinite ease-in-out; }
        .loader-quote { margin-top: 1.5rem; font-size: 1rem; font-style: italic; color: #4b5563; max-width: 90vw; width: 500px; padding: 0 1rem; }
        @keyframes pulse-zoom { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } }
        @keyframes text-fade { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loader-overlay">
        <img src="IMG-20230327-WA0002.jpg" alt="Institute Logo" class="loader-logo">
        <p class="loader-text">Loading Dashboard...</p>
        <p id="loader-motivation-text" class="loader-quote"></p>
    </div>

    <aside id="sidebar" class="bg-gray-800 text-gray-100 w-64 p-4 flex flex-col fixed top-0 right-0 z-[60] translate-x-full lg:translate-x-0">
        <a href="index.html" class="flex items-center space-x-3 pb-4 border-b border-gray-600">
            <img src="IMG-20230327-WA0002.jpg" alt="Institute Logo" class="h-12 w-12 p-0.5 bg-white shadow-md rounded-md">
            <div class="text-left">
                <h1 class="text-sm font-bold text-white leading-tight">Institute of Islamic Education</h1>
                <p class="text-sm font-bold text-green-400" lang="ar" dir="rtl">معهد التربية الاسلامية</p>
            </div>
        </a>
        <nav class="flex-grow mt-4">
            <ul class="space-y-2" id="sidebar-nav">
                <li><a href="#dashboard" class="sidebar-link flex items-center p-2 rounded-md"><i class="fa-solid fa-tachometer-alt fa-fw mr-3"></i>Dashboard</a></li>
                <li><a href="#charts" class="sidebar-link flex items-center p-2 rounded-md"><i class="fa-solid fa-chart-pie fa-fw mr-3"></i>Charts</a></li>
                <li><a href="#management" class="sidebar-link flex items-center p-2 rounded-md"><i class="fa-solid fa-tasks fa-fw mr-3"></i>Management</a></li>
                <li><a href="#all-tasks" class="sidebar-link flex items-center p-2 rounded-md"><i class="fa-solid fa-list-check fa-fw mr-3"></i>All Tasks</a></li>
                <li><a href="#all-users" class="sidebar-link flex items-center p-2 rounded-md"><i class="fa-solid fa-users-cog fa-fw mr-3"></i>All Users</a></li>
            </ul>
        </nav>
        <div class="pt-4 border-t border-gray-600">
            <div class="bg-gray-700 p-3 rounded-lg text-center">
                <i class="fa-solid fa-user-shield fa-2x text-gray-400"></i>
                <p id="adminProfileName" class="font-semibold mt-2">Admin</p>
                <p id="adminProfileEmail" class="text-xs text-gray-400">admin@example.com</p>
            </div>
            <button id="logoutButton" class="w-full mt-4 bg-red-500 text-white font-semibold py-2 rounded-md hover:bg-red-600 transition duration-200">
                <i class="fa-solid fa-right-from-bracket mr-2"></i>Logout
            </button>
        </div>
    </aside>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden lg:hidden"></div>

    <div class="lg:mr-64">
        <header class="bg-white shadow-md sticky top-0 z-40 lg:hidden">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <a href="index.html">
                    <img src="IMG-20230327-WA0002.jpg" alt="Institute Logo" class="h-10 w-10">
                </a>
                
                <span class="text-lg font-bold text-blue-800">Admin Portal</span>

                <button id="menu-toggle-btn" class="text-gray-700">
                    <i class="fa-solid fa-bars fa-lg"></i>
                </button>
            </div>
        </header>

        <main class="container mx-auto p-4 sm:p-6">
            <section id="motivation-hub" class="mb-6 sm:mb-8 scroll-target">
                <div class="motivation-card text-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-3 flex items-center"><i class="fa-solid fa-star mr-3"></i>A Reminder for Us</h2>
                    <blockquote class="border-l-4 border-white pl-4">
                        <p id="motivation-text" class="text-base sm:text-lg italic"></p>
                        <cite id="motivation-source" class="block text-right mt-2 font-semibold"></cite>
                    </blockquote>
                </div>
            </section>
            
            <section id="dashboard" class="mb-6 scroll-target">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Dashboard</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md flex items-center"><i class="fa-solid fa-users fa-2x text-blue-500 mr-4"></i><div><p class="text-gray-500 text-sm">Total Volunteers</p><p id="kpi-total-volunteers" class="text-2xl font-bold">0</p></div></div>
                    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md flex items-center"><i class="fa-solid fa-triangle-exclamation fa-2x text-red-500 mr-4"></i><div><p class="text-gray-500 text-sm">Tasks Overdue</p><p id="kpi-overdue-tasks" class="text-2xl font-bold">0</p></div></div>
                    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md flex items-center"><i class="fa-solid fa-file-alt fa-2x text-gray-500 mr-4"></i><div><p class="text-gray-500 text-sm">Tasks Assigned</p><p id="kpi-tasks-assigned" class="text-2xl font-bold">0</p></div></div>
                    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md flex items-center"><i class="fa-solid fa-check-double fa-2x text-green-500 mr-4"></i><div><p class="text-gray-500 text-sm">Tasks Completed</p><p id="kpi-tasks-completed" class="text-2xl font-bold">0</p></div></div>
                    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md flex items-center"><i class="fa-solid fa-ban fa-2x text-orange-500 mr-4"></i><div><p class="text-gray-500 text-sm">Tasks Blocked</p><p id="kpi-tasks-blocked" class="text-2xl font-bold">0</p></div></div>
                    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md flex items-center"><i class="fa-solid fa-bars-progress fa-2x text-yellow-500 mr-4"></i><div><p class="text-gray-500 text-sm">Tasks In Progress</p><p id="kpi-tasks-in-progress" class="text-2xl font-bold">0</p></div></div>
                    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md flex items-center"><i class="fa-solid fa-calendar-check fa-2x text-purple-500 mr-4"></i><div><p class="text-gray-500 text-sm">Completed (Overdue)</p><p id="kpi-completed-overdue" class="text-2xl font-bold">0</p></div></div>
                </div>
            </section>

            <section class="bg-white p-4 sm:p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-700"><i class="fa-solid fa-bolt mr-2 text-yellow-500"></i>Recent Activity</h2>
                <div id="activityFeed" class="space-y-4 max-h-72 overflow-y-auto pr-2"></div>
            </section>

            <div id="charts" class="grid grid-cols-1 lg:grid-cols-2 gap-6 scroll-target">
                <section id="chart-section" class="mb-6 bg-white p-4 sm:p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">Task Status Overview</h2>
                    <div id="chart-container" class="relative h-64 md:h-80"><canvas id="taskStatusChart"></canvas></div>
                </section>
                <section class="bg-white p-4 sm:p-6 rounded-lg shadow-md mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700"><i class="fa-solid fa-trophy mr-2 text-yellow-500"></i>Volunteer Leaderboard</h2>
                    <div id="leaderboardContainer" class="relative h-64 md:h-80"><canvas id="leaderboardCanvas"></canvas></div>
                </section>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h3 class="font-semibold text-lg mb-4 text-gray-700">Filter Tasks</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 items-end">
                    <div><label for="statusFilter" class="block text-sm font-medium text-gray-600">Status</label><select id="statusFilter" class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"><option value="All">All Statuses</option><option value="Assigned">Assigned</option><option value="In Progress">In Progress</option><option value="Completed">Completed</option><option value="Blocked">Blocked</option></select></div>
                    <div class="lg:col-span-2"><label for="emailSearch" class="block text-sm font-medium text-gray-600">Volunteer Email</label><input type="text" id="emailSearch" placeholder="Search by user email..." class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></div>
                    <div><label for="startDate" class="block text-sm font-medium text-gray-600">Due Date From</label><input type="date" id="startDate" class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></div>
                    <div><label for="endDate" class="block text-sm font-medium text-gray-600">Due Date To</label><input type="date" id="endDate" class="mt-1 w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></div>
                    <div class="md:col-start-4 flex justify-end"><button id="clearFiltersBtn" class="bg-gray-500 text-white font-semibold px-4 py-2 rounded-md hover:bg-gray-600 transition duration-200"><i class="fa-solid fa-times mr-2"></i>Clear</button></div>
                </div>
            </div>

            <div id="management" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6 scroll-target">
                <div class="bg-white rounded-lg shadow-md"><button class="accordion-toggle flex justify-between items-center w-full p-6 text-left"><h2 class="text-lg font-semibold">Assign New Task</h2><svg class="accordion-icon w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div class="accordion-content p-6 border-t border-gray-200 hidden"><form id="assignTaskForm" class="space-y-4"><div><label for="taskTitle" class="block text-sm font-medium text-gray-700">Task Title</label><input type="text" id="taskTitle" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="assignTo" class="block text-sm font-medium text-gray-700">Assign to (User Email)</label><input type="email" id="assignTo" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="dueDate" class="block text-sm font-medium text-gray-700">Due Date</label><input type="date" id="dueDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="taskDesc" class="block text-sm font-medium text-gray-700">Description</label><textarea id="taskDesc" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea></div><button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300">Assign Task</button></form></div></div>
                <div class="bg-white rounded-lg shadow-md"><button class="accordion-toggle flex justify-between items-center w-full p-6 text-left"><h2 class="text-lg font-semibold">Add New User</h2><svg class="accordion-icon w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div class="accordion-content p-6 border-t border-gray-200 hidden"><form id="addVolunteerForm" class="space-y-4"><div><label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label><input type="text" id="fullName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="volEmail" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="volEmail" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="volPassword" class="block text-sm font-medium text-gray-700">Temporary Password</label><input type="password" id="volPassword" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="volRole" class="block text-sm font-medium text-gray-700">Role</label><select id="volRole" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"><option value="Volunteer">Volunteer</option><option value="Admin">Admin</option></select></div><button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition duration-300">Add User</button></form></div></div>
            </div>

            <div id="all-tasks" class="bg-white p-4 sm:p-6 rounded-lg shadow-md mb-6 scroll-target"><div class="flex justify-between items-center mb-4"><h2 class="text-lg font-semibold">All Tasks</h2><div><button id="refreshData" class="text-sm font-normal text-blue-500 hover:underline mr-4">(Refresh)</button><button id="exportTasksBtn" class="bg-green-500 text-white text-sm font-semibold px-3 py-1 rounded-md hover:bg-green-600 transition duration-200"><i class="fa-solid fa-file-csv mr-2"></i>Export</button></div></div><div class="overflow-x-auto"><div id="tasksTableContainer"></div></div></div>
            <div id="all-users" class="bg-white p-4 sm:p-6 rounded-lg shadow-md scroll-target"><div class="flex justify-between items-center mb-4"><h2 class="text-lg font-semibold">All Users</h2><button id="exportUsersBtn" class="bg-green-500 text-white text-sm font-semibold px-3 py-1 rounded-md hover:bg-green-600 transition duration-200"><i class="fa-solid fa-file-csv mr-2"></i>Export</button></div><div class="overflow-x-auto"><div id="volunteersTableContainer"></div></div></div>
        </main>
    </div>

    <div id="editTaskModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[100] hidden"><div class="bg-white p-8 rounded-lg shadow-2xl max-w-md w-full"><h2 class="text-2xl font-bold mb-4">Edit Task</h2><form id="editTaskForm" class="space-y-4"><input type="hidden" id="editTaskId"><div><label for="editTaskTitle" class="block text-sm font-medium text-gray-700">Task Title</label><input type="text" id="editTaskTitle" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="editAssignTo" class="block text-sm font-medium text-gray-700">Assign to (User Email)</label><input type="email" id="editAssignTo" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="editDueDate" class="block text-sm font-medium text-gray-700">Due Date</label><input type="date" id="editDueDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="editTaskDesc" class="block text-sm font-medium text-gray-700">Description</label><textarea id="editTaskDesc" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea></div><div class="mt-6 flex justify-end space-x-4"><button type="button" id="closeEditModalButton" class="bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button><button type="submit" class="bg-blue-600 text-white font-bold px-4 py-2 rounded-md hover:bg-blue-700">Save Changes</button></div></form></div></div>
    <div id="volunteerProfileModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[100] hidden"><div class="bg-white p-6 md:p-8 rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col"><div class="flex justify-between items-center mb-4 pb-4 border-b"><h2 class="text-2xl font-bold text-gray-800">Volunteer Profile</h2><button id="closeProfileModalButton" class="text-gray-500 hover:text-red-600 text-2xl">&times;</button></div><div class="flex-grow overflow-y-auto"><div class="mb-6"><h3 id="profileName" class="text-xl font-bold text-blue-800"></h3><p id="profileEmail" class="text-gray-600"></p></div><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center"><div class="bg-gray-100 p-3 rounded-lg"><p class="text-sm text-gray-500">Total Tasks</p><p id="profileTotalTasks" class="text-xl font-bold"></p></div><div class="bg-green-100 p-3 rounded-lg"><p class="text-sm text-green-700">Completed</p><p id="profileCompletedTasks" class="text-xl font-bold"></p></div><div class="bg-red-100 p-3 rounded-lg"><p class="text-sm text-red-700">Overdue</p><p id="profileOverdueTasks" class="text-xl font-bold"></p></div><div class="bg-blue-100 p-3 rounded-lg"><p class="text-sm text-blue-700">Completion Rate</p><p id="profileCompletionRate" class="text-xl font-bold"></p></div></div><div><h3 class="text-lg font-semibold mb-2 text-gray-700">Assigned Tasks</h3><div id="profileTaskList" class="space-y-3"></div></div></div></div></div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = "https://script.google.com/macros/s/AKfycbxO0V6dKowgCvrN3CwvnPoO2Le4Er6SHcxRkKCO3Cmw4f8CJGu5nSKikTen6VUkGDuy2A/exec";
            const token = localStorage.getItem("sessionToken");
            const loaderOverlay = document.getElementById('loader-overlay'); 

            if (!token) { window.location.href = "./login.html"; }
            
            const sidebar = document.getElementById('sidebar');
            const menuToggleBtn = document.getElementById('menu-toggle-btn');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const body = document.body;

            const toggleSidebar = () => {
                sidebar.classList.toggle('open');
                sidebarOverlay.classList.toggle('hidden');
                body.classList.toggle('body-no-scroll');
            };

            if (menuToggleBtn) menuToggleBtn.addEventListener('click', toggleSidebar);
            if (sidebarOverlay) sidebarOverlay.addEventListener('click', toggleSidebar);

            sidebarLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth < 1024) {
                        toggleSidebar();
                    }
                });
            });

            const sections = document.querySelectorAll('.scroll-target');
            const navLinks = document.querySelectorAll('#sidebar-nav a');
            
            const activateLinkOnScroll = () => {
                let current = '';
                sections.forEach(section => {
                    const sectionTop = section.offsetTop;
                    if (pageYOffset >= sectionTop - 100) {
                        current = section.getAttribute('id');
                    }
                });
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href').slice(1) === current) {
                        link.classList.add('active');
                    }
                });
            };
            window.addEventListener('scroll', activateLinkOnScroll);

            let allTasks = [];
            let allVolunteers = [];
            let sortState = { column: -1, direction: 'asc' };
            let taskStatusChart = null;
            let leaderboardChart = null;

            const motivationalQuotes = [
                { text: `"And cooperate in righteousness and piety, but do not cooperate in sin and aggression."`, source: "Qur'an (5:2)" },
                { text: `"So whoever does an atom's weight of good will see it."`, source: "Qur'an (99:7)" },
                { text: `"The best of people are those who are most beneficial to people."`, source: "Hadith (Al-Mu’jam al-Awsat)" },
                { text: `"Verily, actions are but by intentions, and every man shall have only that which he intended."`, source: "Hadith (Bukhari & Muslim)" },
                { text: `"...and whoever fears Allah - He will make for him a way out and will provide for him from where he does not expect."`, source: "Qur'an (65:2-3)" }
            ];

            function displayMotivation() {
                const randomIndex = Math.floor(Math.random() * motivationalQuotes.length);
                const quote = motivationalQuotes[randomIndex];
                document.getElementById('motivation-text').textContent = quote.text;
                document.getElementById('motivation-source').textContent = `- ${quote.source}`;
                document.getElementById('loader-motivation-text').textContent = quote.text;
            }

            function generateAndRenderActivityFeed(tasks, volunteers) {
                const activityFeedContainer = document.getElementById('activityFeed');
                if (!activityFeedContainer || tasks.length < 2 || volunteers.length < 2) {
                    activityFeedContainer.innerHTML = `<p class="text-gray-500 text-center p-4">No recent activity to display.</p>`;
                    return;
                }
                const taskHeaders = tasks[0];
                const taskData = tasks.slice(1);
                const volHeaders = volunteers[0];
                const volData = volunteers.slice(1);
                let activities = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const findVolunteerName = (email) => {
                    const volunteer = volData.find(v => v[volHeaders.indexOf("Email")] === email);
                    return volunteer ? volunteer[volHeaders.indexOf("FullName")] : email;
                };
                taskData.forEach(task => {
                    const status = task[taskHeaders.indexOf("Status")];
                    const dueDate = new Date(task[taskHeaders.indexOf("DueDate")]);
                    const lastUpdated = new Date(task[taskHeaders.indexOf("LastUpdated")]);
                    const assignedTo = findVolunteerName(task[taskHeaders.indexOf("AssignedToEmail")]);
                    if (status === 'Completed') {
                        activities.push({type: 'task_completed', user: assignedTo, task: task[taskHeaders.indexOf("TaskTitle")], timestamp: lastUpdated});
                    } else {
                        activities.push({type: 'task_assigned', user: assignedTo, task: task[taskHeaders.indexOf("TaskTitle")], timestamp: new Date(task[taskHeaders.indexOf("Timestamp")])});
                        if (dueDate < today) {
                             activities.push({type: 'task_overdue', task: task[taskHeaders.indexOf("TaskTitle")], user: assignedTo, timestamp: dueDate});
                        }
                    }
                });
                activities.sort((a, b) => b.timestamp - a.timestamp);
                activityFeedContainer.innerHTML = ''; 
                if (activities.length === 0) {
                    activityFeedContainer.innerHTML = `<p class="text-gray-500 text-center p-4">No recent activity to display.</p>`;
                    return;
                }
                activities.slice(0, 10).forEach(activity => {
                    const activityElement = document.createElement('div');
                    activityElement.className = 'flex items-start p-2 border-b border-gray-100';
                    let icon = '';
                    let message = '';
                    const timeAgo = Math.round((new Date() - activity.timestamp) / (1000 * 60)); 
                    const timeString = timeAgo < 60 ? `${timeAgo}m ago` : `${Math.round(timeAgo/60)}h ago`;
                    switch (activity.type) {
                        case 'task_completed':
                            icon = `<i class="fa-solid fa-check-circle text-green-500 mt-1 mr-4"></i>`;
                            message = `<div><span class="font-semibold">${activity.user}</span> completed <span class="text-gray-600 italic">"${activity.task}"</span><div class="text-xs text-gray-400">${timeString}</div></div>`;
                            break;
                         case 'task_assigned':
                            icon = `<i class="fa-solid fa-file-circle-plus text-blue-500 mt-1 mr-4"></i>`;
                            message = `<div>A new task <span class="text-gray-600 italic">"${activity.task}"</span> was assigned to <span class="font-semibold">${activity.user}</span><div class="text-xs text-gray-400">${timeString}</div></div>`;
                            break;
                        case 'task_overdue':
                            icon = `<i class="fa-solid fa-exclamation-triangle text-red-500 mt-1 mr-4"></i>`;
                            message = `<div>The task <span class="text-gray-600 italic">"${activity.task}"</span> assigned to <span class="font-semibold">${activity.user}</span> is overdue.<div class="text-xs text-gray-400">${timeString}</div></div>`;
                            break;
                    }
                    activityElement.innerHTML = icon + message;
                    activityFeedContainer.appendChild(activityElement);
                });
            }

            document.getElementById("logoutButton").addEventListener("click", logout);
            document.getElementById("refreshData").addEventListener("click", fetchAdminData);
            document.getElementById("assignTaskForm").addEventListener("submit", handleFormSubmit);
            document.getElementById("addVolunteerForm").addEventListener("submit", handleFormSubmit);
            document.getElementById("editTaskForm").addEventListener("submit", handleTaskUpdate);
            document.getElementById("closeEditModalButton").addEventListener("click", () => document.getElementById('editTaskModal').classList.add('hidden'));
            document.getElementById("closeProfileModalButton").addEventListener("click", () => document.getElementById('volunteerProfileModal').classList.add('hidden'));
            document.getElementById("exportTasksBtn").addEventListener("click", () => exportToCsv('tasks-export.csv', allTasks));
            document.getElementById("exportUsersBtn").addEventListener("click", () => exportToCsv('users-export.csv', allVolunteers));
            document.getElementById('statusFilter').addEventListener('change', applyFiltersAndRender);
            document.getElementById('emailSearch').addEventListener('input', applyFiltersAndRender);
            document.getElementById('startDate').addEventListener('change', applyFiltersAndRender);
            document.getElementById('endDate').addEventListener('change', applyFiltersAndRender);
            document.getElementById('clearFiltersBtn').addEventListener('click', () => {
                document.getElementById('statusFilter').value = 'All';
                document.getElementById('emailSearch').value = '';
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
                applyFiltersAndRender();
            });
            document.querySelectorAll('.accordion-toggle').forEach(button => {
                button.addEventListener('click', () => {
                    const content = button.nextElementSibling;
                    const icon = button.querySelector('.accordion-icon');
                    content.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180');
                });
            });

            function exportToCsv(filename, data) {
                if (!data || data.length < 2) { showToast("No data available to export.", true); return; }
                const csvContent = "data:text/csv;charset=utf-8," + data.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                const today = new Date().toISOString().split('T')[0];
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `${filename.split('.')[0]}-${today}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast("Data exported successfully!");
            }

            function showToast(message, isError = false) {
                Toastify({ text: message, duration: 3000, close: true, gravity: "top", position: "right", style: { background: isError ? "linear-gradient(to right, #ef4444, #b91c1c)" : "linear-gradient(to right, #22c55e, #15803d)" } }).showToast();
            }

            function showLoading(container) {
                if(container) { container.innerHTML = `<div class="flex justify-center items-center p-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-300"></div></div>`; }
            }
            
            function handleAuthError(error) {
                console.error("Auth Error:", error);
                if (error.message.includes("Unauthorized")) {
                    showToast("Session expired. Please log in again.", true);
                    setTimeout(() => { localStorage.clear(); window.location.href = "./login.html"; }, 2000);
                }
                loaderOverlay.classList.add('hidden');
            }

            function postData(payload, callback) {
                payload.token = token;
                fetch(API_URL, {
                    method: 'POST', redirect: 'follow', body: JSON.stringify(payload),
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'error') throw new Error(data.message);
                    if (payload.action === "getUserProfile" && data.profile) {
                        document.getElementById('adminProfileName').textContent = data.profile.fullName || 'Admin';
                        document.getElementById('adminProfileEmail').textContent = data.profile.email || '';
                    }
                    if (callback) { callback(data); } else { showToast(data.message); fetchAdminData(); }
                })
                .catch(err => {
                    showToast(err.message, true);
                    handleAuthError(err);
                });
            }
            
            function logout() {
                if (confirm("Are you sure you want to logout?")) {
                    localStorage.clear();
                    window.location.href = "./login.html";
                }
            }

            function fetchAdminData() {
                loaderOverlay.classList.remove('hidden'); 
                showLoading(document.getElementById("tasksTableContainer"));
                showLoading(document.getElementById("volunteersTableContainer"));
                showLoading(document.getElementById("leaderboardContainer"));
                showLoading(document.getElementById("chart-container"));

                postData({ action: "getUserProfile" }, (profileData) => {
                    if (profileData.status !== 'success') {
                        handleAuthError(new Error("Could not fetch profile"));
                    }
                });

                const adminDataUrl = `${API_URL}?action=getAdminData&token=${token}`;
                const leaderboardUrl = `${API_URL}?action=getLeaderboard&token=${token}`;

                Promise.all([
                    fetch(adminDataUrl).then(res => res.json()),
                    fetch(leaderboardUrl).then(res => res.json())
                ])
                .then(([adminData, leaderboardData]) => {
                    if (adminData.status === 'error') throw new Error(adminData.message);
                    allTasks = adminData.tasks ? [...adminData.tasks] : [];
                    allVolunteers = adminData.volunteers ? [...adminData.volunteers] : [];
                    renderTable(allTasks, document.getElementById("tasksTableContainer"));
                    renderTable(allVolunteers, document.getElementById("volunteersTableContainer"));
                    renderKPIs(allTasks, allVolunteers);
                    renderTaskStatusChart(allTasks);
                    generateAndRenderActivityFeed(allTasks, allVolunteers);

                    if (leaderboardData.status === 'error') throw new Error(leaderboardData.message);
                    renderLeaderboard(leaderboardData.leaderboard);
                })
                .catch(handleAuthError)
                .finally(() => {
                    loaderOverlay.classList.add('hidden');
                });
            }

            function handleFormSubmit(e) {
                e.preventDefault();
                const formId = e.target.id;
                let action, payloadData;
                if (formId === 'assignTaskForm') {
                    action = "assignTask";
                    payloadData = {title: document.getElementById("taskTitle").value, description: document.getElementById("taskDesc").value, assignTo: document.getElementById("assignTo").value, dueDate: document.getElementById("dueDate").value};
                } else if (formId === 'addVolunteerForm') {
                    action = "addVolunteer";
                    payloadData = {fullName: document.getElementById("fullName").value, email: document.getElementById("volEmail").value, password: document.getElementById("volPassword").value, role: document.getElementById("volRole").value};
                }
                loaderOverlay.classList.remove('hidden');
                postData({ action: action, [formId === 'assignTaskForm' ? 'taskData' : 'volunteerData']: payloadData });
                e.target.reset();
            }

            function renderTable(data, container) {
                container.innerHTML = "";
                if (!data || data.length < 2) { container.innerHTML = `<p class="text-gray-500 p-4">No data available.</p>`; return; }
                const table = document.createElement('table');
                table.className = "min-w-full divide-y divide-gray-200";
                const thead = document.createElement('thead');
                thead.className = "bg-gray-50";
                const headerRow = document.createElement('tr');
                const headers = [...data[0]];
                headers.push("Actions");
                headers.forEach((headerText, index) => {
                    const th = document.createElement('th');
                    th.className = "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider";
                    th.textContent = headerText;
                    if (container.id === 'tasksTableContainer' && index < headers.length - 1) {
                        th.classList.add('sortable-header');
                        th.addEventListener('click', () => handleHeaderClick(th, index));
                    }
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);
                const tbody = document.createElement('tbody');
                tbody.className = "bg-white divide-y divide-gray-200";
                const dataRows = data.slice(1);
                dataRows.forEach((rowData, rowIndex) => {
                    const tr = document.createElement('tr');
                    rowData.forEach((cellData) => {
                        const td = document.createElement('td');
                        td.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-700";
                        td.textContent = cellData;
                        tr.appendChild(td);
                    });
                    const actionsTd = document.createElement('td');
                    actionsTd.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-700 space-x-2";
                    if (container.id === 'tasksTableContainer') {
                        const taskId = rowData[0];
                        actionsTd.innerHTML = `<button data-task-id="${taskId}" class="edit-task-btn text-blue-500 hover:text-blue-700"><i class="fa-solid fa-pen-to-square"></i></button><button data-task-id="${taskId}" class="delete-task-btn text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>`;
                    } else if (container.id === 'volunteersTableContainer') {
                        const userEmail = rowData[1];
                        actionsTd.innerHTML = `<button data-user-email="${userEmail}" class="delete-user-btn text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>`;
                    }
                    tr.appendChild(actionsTd);
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                container.appendChild(table);
                container.querySelectorAll('.edit-task-btn').forEach(btn => btn.addEventListener('click', (e) => openEditTaskModal(e.currentTarget.dataset.taskId)));
                container.querySelectorAll('.delete-task-btn').forEach(btn => btn.addEventListener('click', (e) => handleDelete(e.currentTarget.dataset.taskId, 'task')));
                container.querySelectorAll('.delete-user-btn').forEach(btn => btn.addEventListener('click', (e) => handleDelete(e.currentTarget.dataset.userEmail, 'user')));
                if (container.id === 'volunteersTableContainer') {
                    tbody.querySelectorAll('tr').forEach((tr, rowIndex) => {
                        const nameCell = tr.querySelector('td:first-child');
                        if (nameCell) {
                            const userEmail = dataRows[rowIndex][1];
                            nameCell.innerHTML = `<button class="text-blue-600 hover:underline font-semibold">${nameCell.textContent}</button>`;
                            nameCell.querySelector('button').addEventListener('click', () => openVolunteerProfileModal(userEmail));
                        }
                    });
                }
            }

            function openEditTaskModal(taskId) {
                const taskHeaders = allTasks[0];
                const taskData = allTasks.slice(1).find(row => row[taskHeaders.indexOf("TaskID")] === taskId);
                if (taskData) {
                    document.getElementById('editTaskId').value = taskData[taskHeaders.indexOf("TaskID")];
                    document.getElementById('editTaskTitle').value = taskData[taskHeaders.indexOf("TaskTitle")];
                    document.getElementById('editTaskDesc').value = taskData[taskHeaders.indexOf("TaskDescription")];
                    document.getElementById('editAssignTo').value = taskData[taskHeaders.indexOf("AssignedToEmail")];
                    const dueDate = new Date(taskData[taskHeaders.indexOf("DueDate")]);
                    document.getElementById('editDueDate').value = dueDate.toISOString().split('T')[0];
                    document.getElementById('editTaskModal').classList.remove('hidden');
                } else {
                    showToast("Could not find task data.", true);
                }
            }
            
            function openVolunteerProfileModal(email) {
                if (allVolunteers.length < 2 || allTasks.length < 2) { showToast("Data not fully loaded. Please wait a moment and try again.", true); return; }
                const volHeaders = allVolunteers[0];
                const volunteer = allVolunteers.slice(1).find(v => v[volHeaders.indexOf("Email")] === email);
                if (!volunteer) { showToast("Could not find volunteer data.", true); return; }
                const taskHeaders = allTasks[0];
                const volunteerTasks = allTasks.slice(1).filter(t => t[taskHeaders.indexOf("AssignedToEmail")] === email);
                let completed = 0;
                let overdue = 0;
                const today = new Date();
                today.setHours(0,0,0,0);
                volunteerTasks.forEach(task => {
                    if (task[taskHeaders.indexOf("Status")] === 'Completed') { completed++; }
                    const dueDate = new Date(task[taskHeaders.indexOf("DueDate")]);
                    if (task[taskHeaders.indexOf("Status")] !== 'Completed' && dueDate < today) { overdue++; }
                });
                const totalTasks = volunteerTasks.length;
                const completionRate = totalTasks > 0 ? Math.round((completed / totalTasks) * 100) : 0;
                document.getElementById('profileName').textContent = volunteer[volHeaders.indexOf("FullName")];
                document.getElementById('profileEmail').textContent = volunteer[volHeaders.indexOf("Email")];
                document.getElementById('profileTotalTasks').textContent = totalTasks;
                document.getElementById('profileCompletedTasks').textContent = completed;
                document.getElementById('profileOverdueTasks').textContent = overdue;
                document.getElementById('profileCompletionRate').textContent = `${completionRate}%`;
                const taskListContainer = document.getElementById('profileTaskList');
                taskListContainer.innerHTML = ''; 
                if (volunteerTasks.length === 0) {
                    taskListContainer.innerHTML = `<p class="text-gray-500 text-center">No tasks assigned to this volunteer.</p>`;
                } else {
                    volunteerTasks.forEach(task => {
                        const status = task[taskHeaders.indexOf("Status")];
                        const dueDate = new Date(task[taskHeaders.indexOf("DueDate")]);
                        const isOverdue = status !== 'Completed' && dueDate < today;
                        let statusColor = 'bg-blue-100 text-blue-800';
                        if (status === 'In Progress') statusColor = 'bg-yellow-100 text-yellow-800';
                        if (status === 'Completed') statusColor = 'bg-green-100 text-green-800';
                        if (status === 'Blocked') statusColor = 'bg-red-100 text-red-800';
                        const taskElement = document.createElement('div');
                        taskElement.className = `p-3 rounded-md flex justify-between items-center ${isOverdue ? 'bg-red-50 border-l-4 border-red-400' : 'bg-gray-50'}`;
                        taskElement.innerHTML = `<div><p class="font-semibold text-gray-800">${task[taskHeaders.indexOf("TaskTitle")]}</p><p class="text-sm text-gray-500">Due: ${dueDate.toLocaleDateString()}</p></div><span class="text-xs font-bold px-2 py-1 rounded-full ${statusColor}">${status}</span>`;
                        taskListContainer.appendChild(taskElement);
                    });
                }
                document.getElementById('volunteerProfileModal').classList.remove('hidden');
            }

            function handleTaskUpdate(e) {
                e.preventDefault();
                const updateData = {taskId: document.getElementById('editTaskId').value, title: document.getElementById('editTaskTitle').value, description: document.getElementById('editTaskDesc').value, assignTo: document.getElementById('editAssignTo').value, dueDate: document.getElementById('editDueDate').value,};
                loaderOverlay.classList.remove('hidden');
                postData({ action: "updateAdminTask", taskData: updateData });
                document.getElementById('editTaskModal').classList.add('hidden');
            }

            function handleDelete(id, type) {
                const item = type === 'task' ? 'task' : 'user';
                if (confirm(`Are you sure you want to delete this ${item}? This action cannot be undone.`)) {
                    const action = type === 'task' ? 'deleteTask' : 'deleteUser';
                    const payload = { action: action };
                    if (type === 'task') { payload.taskId = id; } else { payload.email = id; }
                    loaderOverlay.classList.remove('hidden');
                    postData(payload);
                }
            }

            function applyFiltersAndRender() {
                if (!allTasks || allTasks.length < 2) return;
                const headers = allTasks[0];
                let dataRows = allTasks.slice(1);
                const statusValue = document.getElementById('statusFilter').value;
                const emailValue = document.getElementById('emailSearch').value.toLowerCase();
                const startDateValue = document.getElementById('startDate').value;
                const endDateValue = document.getElementById('endDate').value;
                if (statusValue !== 'All') {
                    const statusIndex = headers.indexOf('Status');
                    if(statusIndex > -1) dataRows = dataRows.filter(row => row[statusIndex] === statusValue);
                }
                if (emailValue) {
                    const emailIndex = headers.indexOf('AssignedToEmail');
                    if(emailIndex > -1) dataRows = dataRows.filter(row => row[emailIndex].toLowerCase().includes(emailValue));
                }
                const dueDateIndex = headers.indexOf('DueDate');
                if (dueDateIndex > -1) {
                    if (startDateValue) {
                        const startDate = new Date(startDateValue);
                        dataRows = dataRows.filter(row => new Date(row[dueDateIndex]) >= startDate);
                    }
                    if (endDateValue) {
                        const endDate = new Date(endDateValue);
                        endDate.setDate(endDate.getDate() + 1);
                        dataRows = dataRows.filter(row => new Date(row[dueDateIndex]) < endDate);
                    }
                }
                renderTable([headers, ...dataRows], document.getElementById("tasksTableContainer"));
            }

            function handleHeaderClick(headerEl, colIndex) {
                if (!allTasks || allTasks.length < 2) return;
                const headers = allTasks[0];
                if (sortState.column === colIndex) {
                    sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    sortState.column = colIndex;
                    sortState.direction = 'asc';
                }
                let dataRows = allTasks.slice(1);
                dataRows.sort((a, b) => {
                    const valA = a[colIndex];
                    const valB = b[colIndex];
                    if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                    return 0;
                });
                renderTable([headers, ...dataRows], document.getElementById("tasksTableContainer"));
            }

            function renderKPIs(tasks, volunteers) {
                if (!tasks || tasks.length < 2) {
                    document.getElementById('kpi-total-volunteers').textContent = (volunteers && volunteers.length > 1) ? volunteers.length - 1 : 0;
                    document.getElementById('kpi-tasks-in-progress').textContent = 0;
                    document.getElementById('kpi-tasks-completed').textContent = 0;
                    document.getElementById('kpi-overdue-tasks').textContent = 0;
                    document.getElementById('kpi-tasks-assigned').textContent = 0;
                    document.getElementById('kpi-tasks-blocked').textContent = 0;
                    document.getElementById('kpi-completed-overdue').textContent = 0;
                    return;
                }
                const headers = tasks[0];
                const data = tasks.slice(1);
                const statusIndex = headers.indexOf("Status");
                const dueDateIndex = headers.indexOf("DueDate");
                const lastUpdatedIndex = headers.indexOf("LastUpdated");
                let inProgress = 0, completed = 0, overdue = 0, assigned = 0, blocked = 0, completedOverdue = 0;
                const today = new Date();
                today.setHours(0,0,0,0);
                data.forEach(row => {
                    const status = row[statusIndex];
                    const dueDate = new Date(row[dueDateIndex]);
                    const lastUpdatedDate = new Date(row[lastUpdatedIndex]);
                    if (status === 'In Progress') inProgress++;
                    if (status === 'Completed') completed++;
                    if (status === 'Assigned') assigned++;
                    if (status === 'Blocked') blocked++;
                    if (status !== 'Completed' && dueDate < today) { overdue++; }
                    if (status === 'Completed' && lastUpdatedDate > dueDate) { completedOverdue++; }
                });
                document.getElementById('kpi-total-volunteers').textContent = (volunteers && volunteers.length > 1) ? volunteers.length - 1 : 0;
                document.getElementById('kpi-tasks-in-progress').textContent = inProgress;
                document.getElementById('kpi-tasks-completed').textContent = completed;
                document.getElementById('kpi-overdue-tasks').textContent = overdue;
                document.getElementById('kpi-tasks-assigned').textContent = assigned;
                document.getElementById('kpi-tasks-blocked').textContent = blocked;
                document.getElementById('kpi-completed-overdue').textContent = completedOverdue;
            }

            function renderLeaderboard(data) {
                const container = document.getElementById("leaderboardContainer");
                if (leaderboardChart) { leaderboardChart.destroy(); }
                if (!data || data.length < 2) { container.innerHTML = `<p class="text-gray-500 p-4 text-center">No completed tasks yet to generate a leaderboard.</p>`; return; }
                container.innerHTML = '<canvas id="leaderboardCanvas"></canvas>';
                const canvas = document.getElementById("leaderboardCanvas");
                const headers = data.shift();
                const topVolunteers = data.slice(0, 10);
                const names = topVolunteers.map(row => row[0]);
                const scores = topVolunteers.map(row => row[1]);
                const rankColors = ['#FFD700', '#C0C0C0', '#CD7F32'];
                const barColors = topVolunteers.map((_, index) => rankColors[index] || '#3b82f6');
                const ctx = canvas.getContext('2d');
                leaderboardChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: names, datasets: [{ label: 'Volunteer Score', data: scores, backgroundColor: barColors, borderColor: barColors, borderWidth: 1, borderRadius: 4 }] },
                    options: { indexAxis: 'x', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) label += ': '; if (context.parsed.y !== null) label += context.parsed.y; const tasksCompleted = topVolunteers[context.dataIndex][2]; return [label, `Tasks Completed: ${tasksCompleted}`]; } } } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Performance Score' } }, x: { ticks: { font: { weight: 'bold' } } } } }
                });
            }

            function renderTaskStatusChart(tasks) {
                const chartContainer = document.getElementById('chart-container');
                if (taskStatusChart) { taskStatusChart.destroy(); }
                if (!tasks || tasks.length < 2) { chartContainer.innerHTML = `<p class="text-gray-500 p-4 text-center">No task data to display.</p>`; return; }
                chartContainer.innerHTML = `<canvas id="taskStatusChart"></canvas>`;
                const headers = tasks[0];
                const data = tasks.slice(1);
                const statusIndex = headers.indexOf("Status");
                const statusCounts = data.reduce((acc, row) => {
                    const status = row[statusIndex];
                    acc[status] = (acc[status] || 0) + 1;
                    return acc;
                }, {});
                const ctx = document.getElementById('taskStatusChart').getContext('2d');
                taskStatusChart = new Chart(ctx, {
                    type: 'pie',
                    data: { labels: Object.keys(statusCounts), datasets: [{ label: 'Task Status', data: Object.values(statusCounts), backgroundColor: [ 'rgba(255, 206, 86, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(255, 99, 132, 0.7)' ], borderColor: [ 'rgba(255, 206, 86, 1)', 'rgba(54, 162, 235, 1)', 'rgba(75, 192, 192, 1)', 'rgba(255, 99, 132, 1)' ], borderWidth: 1 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', } } }
                });
            }

            displayMotivation();
            fetchAdminData();

        });
    </script>
</body>
</html>