<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .toastify { font-family: 'Inter', sans-serif; border-radius: 0.5rem; }
        .sortable-header { cursor: pointer; }
        .sortable-header:hover { background-color: #f9fafb; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="index.html" class="flex items-center space-x-3">
                <img src="IMG-20230327-WA0002.jpg" alt="Institute Logo" class="h-10 w-10">
                <span class="text-xl font-bold text-blue-800">Admin Portal</span>
            </a>
            <div>
                <span class="text-gray-600 mr-4">Welcome, Admin!</span>
                <button id="logoutButton" class="bg-red-500 text-white font-semibold px-4 py-2 rounded-md hover:bg-red-600 transition duration-200">
                    <i class="fa-solid fa-right-from-bracket mr-2"></i>Logout
                </button>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-6">
        <section id="dashboard" class="mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Dashboard</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                    <i class="fa-solid fa-users fa-2x text-blue-500 mr-4"></i>
                    <div>
                        <p class="text-gray-500 text-sm">Total Volunteers</p>
                        <p id="kpi-total-volunteers" class="text-2xl font-bold">0</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                    <i class="fa-solid fa-bars-progress fa-2x text-yellow-500 mr-4"></i>
                    <div>
                        <p class="text-gray-500 text-sm">Tasks In Progress</p>
                        <p id="kpi-tasks-in-progress" class="text-2xl font-bold">0</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                    <i class="fa-solid fa-check-double fa-2x text-green-500 mr-4"></i>
                    <div>
                        <p class="text-gray-500 text-sm">Total Completed</p>
                        <p id="kpi-completed-month" class="text-2xl font-bold">0</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
                    <i class="fa-solid fa-triangle-exclamation fa-2x text-red-500 mr-4"></i>
                    <div>
                        <p class="text-gray-500 text-sm">Overdue Tasks</p>
                        <p id="kpi-overdue-tasks" class="text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="chart-section" class="mb-6 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Task Status Overview</h2>
            <div id="chart-container" class="max-w-md mx-auto">
                <canvas id="taskStatusChart"></canvas>
            </div>
        </section>
        <section class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">
                <i class="fa-solid fa-trophy mr-2 text-yellow-500"></i>Volunteer Leaderboard
            </h2>
            <div id="leaderboardContainer" class="w-full h-96 relative">
                <canvas id="leaderboardCanvas"></canvas>
            </div>
        </section>

        <div class="bg-white p-4 rounded-lg shadow-md mb-6">
            <h3 class="font-semibold mb-2 text-gray-700">Filter Tasks</h3>
            <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4">
                <select id="statusFilter" class="w-full sm:w-auto border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="All">All Statuses</option>
                    <option value="Assigned">Assigned</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="Blocked">Blocked</option>
                </select>
                <input type="text" id="emailSearch" placeholder="Search by user email..." class="w-full sm:w-auto border-gray-300 rounded-md shadow-sm flex-grow focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-md">
                <button class="accordion-toggle flex justify-between items-center w-full p-6 text-left">
                    <h2 class="text-lg font-semibold">Assign New Task</h2>
                    <svg class="accordion-icon w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div class="accordion-content p-6 border-t border-gray-200 hidden">
                    <form id="assignTaskForm" class="space-y-4">
                        <div>
                            <label for="taskTitle" class="block text-sm font-medium text-gray-700">Task Title</label>
                            <input type="text" id="taskTitle" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="assignTo" class="block text-sm font-medium text-gray-700">Assign to (User Email)</label>
                            <input type="email" id="assignTo" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="dueDate" class="block text-sm font-medium text-gray-700">Due Date</label>
                            <input type="date" id="dueDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                         <div>
                            <label for="taskDesc" class="block text-sm font-medium text-gray-700">Description</label>
                            <textarea id="taskDesc" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300">Assign Task</button>
                    </form>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md">
                <button class="accordion-toggle flex justify-between items-center w-full p-6 text-left">
                    <h2 class="text-lg font-semibold">Add New User</h2>
                    <svg class="accordion-icon w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div class="accordion-content p-6 border-t border-gray-200 hidden">
                    <form id="addVolunteerForm" class="space-y-4">
                        <div>
                            <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" id="fullName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="volEmail" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="volEmail" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="volPassword" class="block text-sm font-medium text-gray-700">Temporary Password</label>
                            <input type="password" id="volPassword" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="volRole" class="block text-sm font-medium text-gray-700">Role</label>
                            <select id="volRole" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="Volunteer">Volunteer</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition duration-300">Add User</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-lg font-semibold mb-4">All Tasks <button id="refreshData" class="text-sm font-normal text-blue-500 ml-2 hover:underline">(Refresh)</button></h2>
            <div id="tasksTableContainer" class="overflow-x-auto"></div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-lg font-semibold mb-4">All Users</h2>
            <div id="volunteersTableContainer" class="overflow-x-auto"></div>
        </div>
    </main>

    <div id="editTaskModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[100] hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-md w-full">
            <h2 class="text-2xl font-bold mb-4">Edit Task</h2>
            <form id="editTaskForm" class="space-y-4">
                <input type="hidden" id="editTaskId">
                <div>
                    <label for="editTaskTitle" class="block text-sm font-medium text-gray-700">Task Title</label>
                    <input type="text" id="editTaskTitle" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="editAssignTo" class="block text-sm font-medium text-gray-700">Assign to (User Email)</label>
                    <input type="email" id="editAssignTo" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="editDueDate" class="block text-sm font-medium text-gray-700">Due Date</label>
                    <input type="date" id="editDueDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                 <div>
                    <label for="editTaskDesc" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="editTaskDesc" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" id="closeEditModalButton" class="bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold px-4 py-2 rounded-md hover:bg-blue-700">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxFuW26BPUhwNnXVz6UaKsBiFZH5uGk_yhe5qY8TbQRHBZxshnYWUcu9OAk3pt2UzaXbg/exec";
        const token = localStorage.getItem("sessionToken");

        if (!token) { window.location.href = "./login.html"; }
        
        let allTasks = [];
        let allVolunteers = [];
        let sortState = { column: -1, direction: 'asc' };
        let taskStatusChart = null;
        let leaderboardChart = null;

        // --- Event Listeners ---
        document.getElementById("logoutButton").addEventListener("click", logout);
        document.getElementById("refreshData").addEventListener("click", fetchAdminData);
        document.getElementById("assignTaskForm").addEventListener("submit", handleFormSubmit);
        document.getElementById("addVolunteerForm").addEventListener("submit", handleFormSubmit);
        document.getElementById('statusFilter').addEventListener('change', applyFiltersAndRender);
        document.getElementById('emailSearch').addEventListener('input', applyFiltersAndRender);
        document.getElementById("editTaskForm").addEventListener("submit", handleTaskUpdate);
        document.getElementById("closeEditModalButton").addEventListener("click", () => document.getElementById('editTaskModal').classList.add('hidden'));

        // --- Core Functions ---
        function showToast(message, isError = false) {
            Toastify({ text: message, duration: 3000, close: true, gravity: "top", position: "right", style: { background: isError ? "linear-gradient(to right, #ef4444, #b91c1c)" : "linear-gradient(to right, #22c55e, #15803d)" } }).showToast();
        }

        function showLoading(container) {
            container.innerHTML = `<div class="flex justify-center items-center p-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>`;
        }

        function handleAuthError(error) {
            console.error("Auth Error:", error);
            if (error.message.includes("Unauthorized")) {
                showToast("Session expired. Please log in again.", true);
                setTimeout(() => {
                    localStorage.clear();
                    window.location.href = "./login.html";
                }, 2000);
            }
        }

        function postData(payload) {
            payload.token = token;
            fetch(API_URL, {
                method: 'POST', redirect: 'follow', body: JSON.stringify(payload),
                headers: { "Content-Type": "text/plain;charset=utf-8" },
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'error') throw new Error(data.message);
                showToast(data.message);
                fetchAdminData();
            })
            .catch(err => {
                showToast(err.message, true);
                handleAuthError(err);
            });
        }
        
        function logout() {
            if (confirm("Are you sure you want to logout?")) {
                localStorage.clear();
                window.location.href = "./login.html";
            }
        }

        function fetchAdminData() {
            showLoading(document.getElementById("tasksTableContainer"));
            showLoading(document.getElementById("volunteersTableContainer"));
            showLoading(document.getElementById("leaderboardContainer"));
            
            fetch(`${API_URL}?action=getAdminData&token=${token}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'error') throw new Error(data.message);
                    allTasks = data.tasks ? [...data.tasks] : [];
                    allVolunteers = data.volunteers ? [...data.volunteers] : [];
                    renderTable([...data.tasks], document.getElementById("tasksTableContainer"));
                    renderTable([...data.volunteers], document.getElementById("volunteersTableContainer"));
                    renderKPIs(data.tasks, data.volunteers);
                    renderTaskStatusChart(data.tasks);
                })
                .catch(handleAuthError);

            fetch(`${API_URL}?action=getLeaderboard&token=${token}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'error') throw new Error(data.message);
                    renderLeaderboard(data.leaderboard);
                })
                .catch(handleAuthError);
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            const formId = e.target.id;
            let action, payloadData;
            if (formId === 'assignTaskForm') {
                action = "assignTask";
                payloadData = {
                    title: document.getElementById("taskTitle").value,
                    description: document.getElementById("taskDesc").value,
                    assignTo: document.getElementById("assignTo").value,
                    dueDate: document.getElementById("dueDate").value
                };
            } else if (formId === 'addVolunteerForm') {
                action = "addVolunteer";
                payloadData = {
                    fullName: document.getElementById("fullName").value,
                    email: document.getElementById("volEmail").value,
                    password: document.getElementById("volPassword").value,
                    role: document.getElementById("volRole").value
                };
            }
            postData({ action: action, [formId === 'assignTaskForm' ? 'taskData' : 'volunteerData']: payloadData });
            e.target.reset();
        }

        function renderTable(data, container) {
            container.innerHTML = "";
            if (!data || data.length < 2) {
                container.innerHTML = `<p class="text-gray-500 p-4">No data available.</p>`;
                return;
            }

            const table = document.createElement('table');
            table.className = "min-w-full divide-y divide-gray-200";
            const thead = document.createElement('thead');
            thead.className = "bg-gray-50";
            const headerRow = document.createElement('tr');
            
            const headers = [...data[0]];
            headers.push("Actions");

            headers.forEach((headerText, index) => {
                const th = document.createElement('th');
                th.className = "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider";
                th.textContent = headerText;
                
                if (container.id === 'tasksTableContainer' && index < headers.length - 1) {
                    th.classList.add('sortable-header');
                    th.addEventListener('click', handleHeaderClick);
                }
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            tbody.className = "bg-white divide-y divide-gray-200";
            const dataRows = data.slice(1);
            dataRows.forEach(rowData => {
                const tr = document.createElement('tr');
                rowData.forEach(cellData => {
                    const td = document.createElement('td');
                    td.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-700";
                    td.textContent = cellData;
                    tr.appendChild(td);
                });

                const actionsTd = document.createElement('td');
                actionsTd.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-700 space-x-2";
                if (container.id === 'tasksTableContainer') {
                    const taskId = rowData[0];
                    actionsTd.innerHTML = `
                        <button onclick="openEditTaskModal('${taskId}')" class="text-blue-500 hover:text-blue-700"><i class="fa-solid fa-pen-to-square"></i></button>
                        <button onclick="handleDelete('${taskId}', 'task')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
                    `;
                } else if (container.id === 'volunteersTableContainer') {
                    const userEmail = rowData[1];
                    actionsTd.innerHTML = `
                        <button onclick="handleDelete('${userEmail}', 'user')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
                    `;
                }
                tr.appendChild(actionsTd);
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            container.appendChild(table);
        }
        
        function openEditTaskModal(taskId) {
            const taskHeaders = allTasks[0];
            const taskData = allTasks.slice(1).find(row => row[taskHeaders.indexOf("TaskID")] === taskId);
            if (taskData) {
                document.getElementById('editTaskId').value = taskData[taskHeaders.indexOf("TaskID")];
                document.getElementById('editTaskTitle').value = taskData[taskHeaders.indexOf("TaskTitle")];
                document.getElementById('editTaskDesc').value = taskData[taskHeaders.indexOf("TaskDescription")];
                document.getElementById('editAssignTo').value = taskData[taskHeaders.indexOf("AssignedToEmail")];
                const dueDate = new Date(taskData[taskHeaders.indexOf("DueDate")]);
                document.getElementById('editDueDate').value = dueDate.toISOString().split('T')[0];
                document.getElementById('editTaskModal').classList.remove('hidden');
            } else {
                showToast("Could not find task data.", true);
            }
        }

        function handleTaskUpdate(e) {
            e.preventDefault();
            const updateData = {
                taskId: document.getElementById('editTaskId').value,
                title: document.getElementById('editTaskTitle').value,
                description: document.getElementById('editTaskDesc').value,
                assignTo: document.getElementById('editAssignTo').value,
                dueDate: document.getElementById('editDueDate').value,
            };
            postData({ action: "updateAdminTask", taskData: updateData });
            document.getElementById('editTaskModal').classList.add('hidden');
        }

        function handleDelete(id, type) {
            const item = type === 'task' ? 'task' : 'user';
            if (confirm(`Are you sure you want to delete this ${item}? This action cannot be undone.`)) {
                const action = type === 'task' ? 'deleteTask' : 'deleteUser';
                const payload = { action: action };
                if (type === 'task') {
                    payload.taskId = id;
                } else {
                    payload.email = id;
                }
                postData(payload);
            }
        }

        function applyFiltersAndRender() {
            if (allTasks.length < 2) return;
            const headers = allTasks[0];
            let dataRows = allTasks.slice(1);

            const statusValue = document.getElementById('statusFilter').value;
            const emailValue = document.getElementById('emailSearch').value.toLowerCase();
            
            if (statusValue !== 'All') {
                const statusIndex = headers.indexOf('Status');
                if(statusIndex > -1) dataRows = dataRows.filter(row => row[statusIndex] === statusValue);
            }
            if (emailValue) {
                const emailIndex = headers.indexOf('AssignedToEmail');
                if(emailIndex > -1) dataRows = dataRows.filter(row => row[emailIndex].toLowerCase().includes(emailValue));
            }
            
            renderTable([headers, ...dataRows], document.getElementById("tasksTableContainer"));
        }

        function handleHeaderClick(e) {
            if (allTasks.length < 2) return;
            const headers = allTasks[0];
            const headerText = e.target.textContent.replace(' ▲', '').replace(' ▼', '');
            const colIndex = headers.indexOf(headerText);

            if (colIndex === -1) return;

            if (sortState.column === colIndex) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = colIndex;
                sortState.direction = 'asc';
            }

            let dataRows = allTasks.slice(1);
            dataRows.sort((a, b) => {
                const valA = a[colIndex];
                const valB = b[colIndex];
                if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                return 0;
            });

            renderTable([headers, ...dataRows], document.getElementById("tasksTableContainer"));
        }

        function renderKPIs(tasks, volunteers) {
            if (!tasks || tasks.length < 2) {
                document.getElementById('kpi-total-volunteers').textContent = volunteers ? volunteers.length - 1 : 0;
                document.getElementById('kpi-tasks-in-progress').textContent = 0;
                document.getElementById('kpi-completed-month').textContent = 0;
                document.getElementById('kpi-overdue-tasks').textContent = 0;
                return;
            };
            const headers = tasks[0];
            const data = tasks.slice(1);
            const statusIndex = headers.indexOf("Status");
            const dueDateIndex = headers.indexOf("DueDate");

            let inProgress = 0;
            let totalCompleted = 0;
            let overdue = 0;
            const today = new Date();

            data.forEach(row => {
                if (row[statusIndex] === 'In Progress') {
                    inProgress++;
                }
                if (row[statusIndex] === 'Completed') {
                    totalCompleted++;
                }
                const dueDate = new Date(row[dueDateIndex]);
                if (row[statusIndex] !== 'Completed' && dueDate < today) {
                    overdue++;
                }
            });
            
            document.getElementById('kpi-total-volunteers').textContent = volunteers ? volunteers.length - 1 : 0;
            document.getElementById('kpi-tasks-in-progress').textContent = inProgress;
            document.getElementById('kpi-completed-month').textContent = totalCompleted;
            document.getElementById('kpi-overdue-tasks').textContent = overdue;
        }

        function renderLeaderboard(data) {
            const container = document.getElementById("leaderboardContainer");
            
            if (leaderboardChart) {
                leaderboardChart.destroy();
            }

            if (!data || data.length < 2) {
                container.innerHTML = `<p class="text-gray-500 p-4 text-center">No completed tasks yet to generate a leaderboard.</p>`;
                return;
            }
            
            container.innerHTML = '<canvas id="leaderboardCanvas"></canvas>';
            const canvas = document.getElementById("leaderboardCanvas");

            const headers = data.shift();
            const topVolunteers = data.slice(0, 10);

            const names = topVolunteers.map(row => row[0]);
            const scores = topVolunteers.map(row => row[1]);
            
            const rankColors = ['#FFD700', '#C0C0C0', '#CD7F32'];
            const barColors = topVolunteers.map((_, index) => rankColors[index] || '#3b82f6');

            const ctx = canvas.getContext('2d');
            leaderboardChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: names,
                    datasets: [{
                        label: 'Volunteer Score',
                        data: scores,
                        backgroundColor: barColors,
                        borderColor: barColors,
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.x !== null) label += context.parsed.x;
                                    const tasksCompleted = topVolunteers[context.dataIndex][2];
                                    return [label, `Tasks Completed: ${tasksCompleted}`];
                                }
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, title: { display: true, text: 'Performance Score' } },
                        y: { ticks: { font: { weight: 'bold' } } }
                    }
                }
            });
        }

        function renderTaskStatusChart(tasks) {
            const chartContainer = document.getElementById('chart-container');
            if (taskStatusChart) {
                taskStatusChart.destroy();
            }
            if (!tasks || tasks.length < 2) {
                chartContainer.innerHTML = `<p class="text-gray-500 p-4 text-center">No task data to display.</p>`;
                return;
            }
            chartContainer.innerHTML = `<canvas id="taskStatusChart"></canvas>`;
            
            const headers = tasks[0];
            const data = tasks.slice(1);
            const statusIndex = headers.indexOf("Status");

            const statusCounts = data.reduce((acc, row) => {
                const status = row[statusIndex];
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});

            const ctx = document.getElementById('taskStatusChart').getContext('2d');
            taskStatusChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        label: 'Task Status',
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(255, 99, 132, 0.7)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }

        document.querySelectorAll('.accordion-toggle').forEach(button => {
            button.addEventListener('click', () => {
                const content = button.nextElementSibling;
                const icon = button.querySelector('.accordion-icon');
                content.classList.toggle('hidden');
                icon.classList.toggle('rotate-180');
            });
        });

        fetchAdminData();
    </script>
</body>
</html>