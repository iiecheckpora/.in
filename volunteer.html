<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Tasks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Mirza:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; }
        .body-no-scroll { overflow: hidden; }
        .toastify { font-family: 'Inter', sans-serif; border-radius: 0.5rem; }
        .accordion-icon.rotate-180 { transform: rotate(180deg); }
        .motivation-card {
            background: linear-gradient(135deg, #1e3a8a 0%, #16a34a 100%);
        }
        [lang="ar"] { font-family: 'Mirza', serif; }
        .scroll-target { scroll-margin-top: 80px; }

        /* Sidebar Styles */
        #sidebar { 
            transition: transform 0.3s ease-in-out; 
            background-color: #1e3a8a; /* New menu color */
            height: 100vh; /* Fallback for older browsers */
            height: 100dvh; /* Fix for mobile browser UI */
        }
        #sidebar.open { 
            transform: translateX(0); 
        }
        .sidebar-link { 
            transition: background-color 0.2s, color 0.2s; 
        }
        .sidebar-link:hover { 
            background-color: #2563eb; /* A lighter blue for hover */
            color: white; 
        }
        .sidebar-link.active { 
            background-color: #1d4ed8; /* A slightly different blue for active */
            color: white; 
            font-weight: 600; 
        }

        /* Loader Styles */
        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #ffffff; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
            transition: opacity 0.75s ease-in-out, visibility 0.75s;
            opacity: 1; visibility: visible; text-align: center;
        }
        #loader-overlay.hidden { opacity: 0; visibility: hidden; }
        .loader-logo { width: 80px; height: 80px; animation: pulse-zoom 2s infinite cubic-bezier(0.4, 0, 0.6, 1); }
        .loader-text { margin-top: 1rem; font-size: 1.125rem; font-weight: 600; color: #1e3a8a; animation: text-fade 2s infinite ease-in-out; }
        .loader-quote { margin-top: 1.5rem; font-size: 1rem; font-style: italic; color: #4b5563; max-width: 90vw; width: 500px; padding: 0 1rem; }
        @keyframes pulse-zoom { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } }
        @keyframes text-fade { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* 3D Cube Loader for Notification Section */
        .notification-loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 120px;
        }
        .cube {
            width: 40px;
            height: 40px;
            position: relative;
            transform-style: preserve-3d;
            animation: spin-cube 1.2s infinite linear;
        }
        .cube-face {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #3b82f6;
            opacity: 0.8;
            border: 2px solid #2563eb;
        }
        .cube-face.front  { transform: rotateY(  0deg) translateZ(20px); }
        .cube-face.back   { transform: rotateY(180deg) translateZ(20px); }
        .cube-face.right  { transform: rotateY( 90deg) translateZ(20px); }
        .cube-face.left   { transform: rotateY(-90deg) translateZ(20px); }
        .cube-face.top    { transform: rotateX( 90deg) translateZ(20px); }
        .cube-face.bottom { transform: rotateX(-90deg) translateZ(20px); }

        @keyframes spin-cube {
            0%   { transform: rotateX(0deg) rotateY(0deg); }
            100% { transform: rotateX(360deg) rotateY(360deg); }
        }

        /* Bell swing animation */
        .bell-animate {
            animation: bell-swing 0.7s infinite cubic-bezier(0.4,0,0.6,1);
            transform-origin: top center;
        }
        @keyframes bell-swing {
            0%   { transform: rotate(0deg);}
            20%  { transform: rotate(-20deg);}
            40%  { transform: rotate(15deg);}
            60%  { transform: rotate(-10deg);}
            80%  { transform: rotate(5deg);}
            100% { transform: rotate(0deg);}
        }
        select {
    border-radius: 0.75rem !important; /* More pronounced rounding */
}
.choices__list--dropdown, .choices__list[role="listbox"] {
    border-radius: 0.75rem !important;
    overflow: hidden;
}
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loader-overlay">
        <img src="IMG-20230327-WA0002.jpg" alt="Institute Logo" class="loader-logo">
        <p class="loader-text">Loading Dashboard...</p>
        <p id="loader-motivation-text" class="loader-quote"></p>
    </div>

    <aside id="sidebar" class="text-gray-100 w-64 p-4 flex flex-col fixed top-0 right-0 z-[60] translate-x-full lg:translate-x-0">
        <a href="index.html" class="flex items-center space-x-3 pb-4 border-b border-blue-500">
            <img src="IMG-20230327-WA0002.jpg" alt="Institute Logo" class="h-12 w-12 p-0.5 bg-white shadow-md rounded-md">
            <div class="text-left">
                <h1 class="text-sm font-bold text-white leading-tight">Institute of Islamic Education</h1>
                <p class="text-sm font-bold text-green-400" lang="ar" dir="rtl">معهد التربية الاسلامية</p>
            </div>
        </a>
        <nav class="flex-grow mt-4">
            <ul class="space-y-2" id="sidebar-nav">
                <li><a href="#personal-dashboard" class="sidebar-link flex items-center p-2 rounded-md"><i class="fa-solid fa-tachometer-alt fa-fw mr-3"></i>Dashboard</a></li>
                <li><a href="#tasksContainer" class="sidebar-link flex items-center p-2 rounded-md"><i class="fa-solid fa-tasks fa-fw mr-3"></i>My Tasks</a></li>
                <li><a href="profile.html" class="sidebar-link flex items-center p-2 rounded-md"><i class="fa-solid fa-user fa-fw mr-3"></i>My Profile</a></li>
                <li>
    <a href="#notifications" class="sidebar-link flex items-center p-2 rounded-md relative">
        <i class="fa-solid fa-bell fa-fw mr-3"></i>
        Notifications
        <span id="sidebar-notification-count" class="absolute right-2 top-2 bg-red-500 text-white text-xs rounded-full px-2 py-0.5 hidden"></span>
    </a>
</li>
            </ul>
        </nav>
        <div class="pt-4 border-t border-blue-500">
             <div id="welcomeMessageContainer" class="bg-blue-700 p-3 rounded-lg text-center">
                <i class="fa-solid fa-user-check fa-2x text-blue-300"></i>
                <p id="welcomeMessage" class="font-semibold mt-2">Welcome!</p>
            </div>
            <button id="logoutButton" class="w-full mt-4 bg-red-500 text-white font-semibold py-2 rounded-md hover:bg-red-600 transition duration-200">
                <i class="fa-solid fa-right-from-bracket mr-2"></i>Logout
            </button>
        </div>
    </aside>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden lg:hidden"></div>

    <div class="lg:mr-64">
        <header class="bg-white shadow-md sticky top-0 z-40 lg:hidden">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <a href="index.html">
                    <img src="IMG-20230327-WA0002.jpg" alt="Institute Logo" class="h-12 w-12 p-0.5 bg-white shadow-md rounded-md">
                </a>
                <span class="text-lg font-bold text-blue-800">Volunteer Portal</span>
                <div class="flex items-center space-x-4">
                    <button id="notification-bell" class="relative text-gray-700 focus:outline-none">
                        <i class="fa-solid fa-bell fa-lg"></i>
                        <span id="notification-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full px-2 py-0.5 hidden"></span>
                    </button>
                    <button id="menu-toggle-btn" class="text-gray-700">
                        <i class="fa-solid fa-bars fa-lg"></i>
                    </button>
                </div>
            </div>
            <div id="notification-dropdown" class="absolute right-4 mt-2 w-80 bg-white rounded-lg shadow-lg border z-50 hidden">
                <div class="p-4 border-b font-bold text-gray-700">Notifications</div>
                <div id="dropdown-notification-list" class="max-h-80 overflow-y-auto"></div>
                <div class="p-2 text-center text-sm text-gray-400">End of notifications</div>
            </div>
        </header>

        <main class="container mx-auto p-4 sm:p-6">

            <section id="motivation-hub" class="mb-6 sm:mb-8 scroll-target">
                <div class="motivation-card text-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-3 flex items-center"><i class="fa-solid fa-star mr-3"></i>A Reminder for Us</h2>
                    <blockquote class="border-l-4 border-white pl-4">
                        <p id="motivation-text" class="text-base sm:text-lg italic"></p>
                        <cite id="motivation-source" class="block text-right mt-2 font-semibold"></cite>
                    </blockquote>
                </div>
            </section>
            
            <section id="personal-dashboard" class="mb-6 scroll-target">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">My Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6 mb-6">
                    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                        <p class="text-gray-500 text-sm">Tasks In Progress</p>
                        <p id="kpi-in-progress" class="text-2xl font-bold">0</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                        <p class="text-gray-500 text-sm">Total Completed</p>
                        <p id="kpi-completed" class="text-2xl font-bold">0</p>
                    </div>
                    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                        <p class="text-gray-500 text-sm">Next Due Date</p>
                        <p id="kpi-next-due" class="text-2xl font-bold">N/A</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-semibold">Your Progress</h3>
                        <span id="progress-text" class="font-semibold text-gray-600">0/0 Tasks</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div id="progress-bar" class="bg-green-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </section>

            <section class="bg-white p-4 rounded-xl shadow-lg mb-6">
                <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                    <div class="flex-1">
                        <label for="statusFilter" class="block text-sm font-semibold text-blue-700 mb-1">Filter by Status</label>
                        <div class="relative">
                            <select id="statusFilter" class="block w-full border border-blue-200 rounded-lg py-2 pl-3 pr-10 text-sm focus:ring-blue-500 focus:border-blue-500 bg-blue-50 font-medium transition">
                                <option value="All">All Active</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Assigned">Assigned</option>
                                <option value="Blocked">Blocked</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex-1">
                        <label for="sortOrder" class="block text-sm font-semibold text-blue-700 mb-1">Sort by Due Date</label>
                        <div class="relative">
                            <select id="sortOrder" class="block w-full border border-blue-200 rounded-lg py-2 pl-3 pr-10 text-sm focus:ring-blue-500 focus:border-blue-500 bg-blue-50 font-medium transition">
                                <option value="asc">Nearest First</option>
                                <option value="desc">Farthest First</option>
                            </select>
                        </div>
                    </div>
                </div>
            </section>

            <h2 class="text-xl font-semibold mb-4 text-gray-700">Your Assigned Tasks</h2>
            <div id="tasksContainer" class="space-y-6 scroll-target">
            </div>
            <section id="notifications" class="scroll-target mt-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Notifications</h2>
                        <i class="fa-solid fa-bell text-gray-400 fa-lg"></i>
                    </div>
                    <div id="user-notification-list" class="space-y-4 max-h-[260px] overflow-y-auto pr-2">
                        <!-- Notifications will be rendered here -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = "https://script.google.com/macros/s/AKfycbyZUu0bV3qDbdHW3k18Mi46yEcn2jYT8NcPAPe3LG6G8uWLlWYGr8TXmcVV5N5kQSeXYw/exec";
            const token = localStorage.getItem("sessionToken");
            const loaderOverlay = document.getElementById('loader-overlay'); 

            if (!token) { window.location.href = "login.html"; }

            let allTasksData = [];
            
            const sidebar = document.getElementById('sidebar');
            const menuToggleBtn = document.getElementById('menu-toggle-btn');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const body = document.body;

            const toggleSidebar = () => {
                sidebar.classList.toggle('open');
                sidebarOverlay.classList.toggle('hidden');
                body.classList.toggle('body-no-scroll');
            };

            if (menuToggleBtn) menuToggleBtn.addEventListener('click', toggleSidebar);
            if (sidebarOverlay) sidebarOverlay.addEventListener('click', toggleSidebar);
            
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth < 1024) {
                        toggleSidebar();
                    }
                    if (link.getAttribute('href') === '#notifications') {
                        document.getElementById('notifications').scrollIntoView({ behavior: 'smooth' });
                    }
                });
            });

            // --- Event Listeners ---
            document.getElementById('statusFilter').addEventListener('change', applyFiltersAndSort);
            document.getElementById('sortOrder').addEventListener('change', applyFiltersAndSort);
            document.getElementById("logoutButton").addEventListener("click", logout);

            const bellBtn = document.getElementById('notification-bell');
            const dropdown = document.getElementById('notification-dropdown');

            if (bellBtn) {
                bellBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dropdown.classList.toggle('hidden');
                });
                // Hide dropdown when clicking outside
                document.addEventListener('click', () => {
                    dropdown.classList.add('hidden');
                });
                dropdown.addEventListener('click', (e) => e.stopPropagation());
            }

            // --- Core Functions ---
            function showToast(message, isError = false) {
                Toastify({
                    text: message,
                    duration: 3500,
                    close: true,
                    gravity: "top", // Show at top
                    position: "center", // Centered horizontally
                    style: {
                        background: isError 
                            ? "linear-gradient(to right, #ef4444, #b91c1c)" 
                            : "linear-gradient(90deg, #3b82f6 0%, #16a34a 100%)",
                        color: "#fff",
                        fontWeight: "600",
                        fontSize: "1rem",
                        borderRadius: "0.75rem",
                        boxShadow: "0 4px 16px rgba(59,130,246,0.15)",
                        padding: "1rem 2rem"
                    }
                }).showToast();
            }

            const motivationalQuotes = [
                { text: "Verily, actions are but by intentions, and every man shall have only that which he intended.", source: "Hadith (Bukhari & Muslim)" },
                { text: "So whoever does an atom's weight of good will see it.", source: "Quran (99:7)" }
            ];

            function displayMotivation() {
                const quote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
                document.getElementById('motivation-text').textContent = `"${quote.text}"`;
                document.getElementById('motivation-source').textContent = `- ${quote.source}`;
                document.getElementById('loader-motivation-text').textContent = quote.text;
            }

            function handleAuthError(error) {
            console.error("Auth Error:", error);
                if (error.message.includes("Unauthorized")) {
                    showToast("Session expired. Please log in again.", true);
                    setTimeout(() => {
                        localStorage.clear();
                        window.location.href = "login.html";
                    }, 2000);
                }
            }

            function postData(payload, callback) {
                payload.token = token;
                if (payload.action === 'updateTask') loaderOverlay.classList.remove('hidden');

                fetch(API_URL, {
                    method: 'POST', redirect: 'follow', body: JSON.stringify(payload),
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'error') throw new Error(data.message);
                    if(data.message) showToast(data.message);
                    if (payload.action === 'updateTask') fetchMyTasks(false);
                    if (callback) callback(data);
                })
                .catch(err => {
                    showToast(err.message, true);
                    handleAuthError(err);
                    if (payload.action === 'updateTask') loaderOverlay.classList.add('hidden');
                });
            }
            
            function logout() {
                if (confirm("Are you sure you want to logout?")) {
                    localStorage.clear();
                    window.location.href = "login.html";
                }
            }

            function fetchMyTasks(showLoader = true) {
                if (showLoader) loaderOverlay.classList.remove('hidden');
                
                const tasksPromise = fetch(`${API_URL}?action=getVolunteerTasks&token=${token}`).then(res => res.json());
                
                if (showLoader) {
                    postData({ action: "getUserProfile" }, (profileData) => {
                        if (profileData.status === 'success') {
                            document.getElementById('welcomeMessage').textContent = `Welcome, ${profileData.profile.fullName}!`;
                        }
                    });
                }

                tasksPromise.then(data => {
                    if (data.status === 'error') throw new Error(data.message);
                    allTasksData = data.tasks; 
                    renderDashboard(allTasksData); 
                    applyFiltersAndSort(); 
                })
                .catch(handleAuthError)
                .finally(() => {
                    loaderOverlay.classList.add('hidden');
                    fetchUserNotifications(); // <-- THIS IS THE NEW, IMPORTANT LINE
                });
            }
            
            // =======================================================
            // --- NEW NOTIFICATION FUNCTIONS (Paste the entire block)---
            // =======================================================
            
            function fetchUserNotifications() {
                const userNotificationList = document.getElementById('user-notification-list');
                const dropdownList = document.getElementById('dropdown-notification-list');
                const bellIcon = document.querySelector('#notification-bell i');
                // Show loader and animate bell
                if (userNotificationList) userNotificationList.innerHTML = `
        <div class="notification-loader">
            <div class="cube">
                <div class="cube-face front"></div>
                <div class="cube-face back"></div>
                <div class="cube-face right"></div>
                <div class="cube-face left"></div>
                <div class="cube-face top"></div>
                <div class="cube-face bottom"></div>
            </div>
            <div class="mt-4 text-blue-700 font-semibold">Loading notifications...</div>
        </div>
    `;
                if (dropdownList) dropdownList.innerHTML = '<p class="text-gray-500 p-4">Loading...</p>';
                if (bellIcon) bellIcon.classList.add('bell-animate');
                fetch(`${API_URL}?action=getNotifications&token=${token}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            renderNotifications(data.notifications);
                            renderDropdownNotifications(data.notifications);
                            updateNotificationCount(data.notifications);
                        } else throw new Error(data.message);
                    })
                    .catch(err => {
                        if (userNotificationList) userNotificationList.innerHTML = '<p class="text-red-500">Could not load notifications.</p>';
                        if (dropdownList) dropdownList.innerHTML = '<p class="text-red-500 p-4">Could not load notifications.</p>';
                        console.error("Error fetching notifications:", err);
                    })
                    .finally(() => {
                        if (bellIcon) bellIcon.classList.remove('bell-animate');
                    });
            }

            function renderDropdownNotifications(notifications) {
                const dropdownList = document.getElementById('dropdown-notification-list');
                if (!dropdownList) return;
                dropdownList.innerHTML = '';
                if (!notifications || notifications.length === 0) {
                    dropdownList.innerHTML = '<p class="text-gray-500 p-4">No notifications.</p>';
                    return;
                }
                notifications.slice(0, 10).forEach(notif => {
                    const isRead = notif.status === 'Read';
                    const notifItem = document.createElement('div');
                    notifItem.className = `p-3 border-b last:border-b-0 cursor-pointer hover:bg-gray-50 ${isRead ? 'bg-gray-50' : 'bg-white'}`;
                    notifItem.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-gray-800">${notif.subject}</span>
                            <span class="text-xs text-gray-500">${new Date(notif.timestamp).toLocaleDateString()}</span>
                        </div>
                        <div class="text-sm text-gray-600 mt-1">${notif.body}</div>
                        ${!isRead ? `<span class="inline-block mt-2 px-2 py-0.5 text-xs font-semibold bg-blue-100 text-blue-700 rounded-full">New</span>` : ''}
                    `;
                    notifItem.addEventListener('click', () => {
                        dropdown.classList.add('hidden');
                        document.getElementById('notifications').scrollIntoView({ behavior: 'smooth' });
                    });
                    dropdownList.appendChild(notifItem);
                });
            }

            function updateNotificationCount(notifications) {
                const count = notifications.filter(n => n.status !== 'Read').length;
                const countEl = document.getElementById('notification-count');
                const sidebarCountEl = document.getElementById('sidebar-notification-count');
                if (count > 0) {
                    countEl.textContent = count;
                    countEl.classList.remove('hidden');
                    if (sidebarCountEl) {
                        sidebarCountEl.textContent = count;
                        sidebarCountEl.classList.remove('hidden');
                    }
                } else {
                    countEl.classList.add('hidden');
                    if (sidebarCountEl) sidebarCountEl.classList.add('hidden');
                }
            }
            
            function renderNotifications(notifications) {
                const userNotificationList = document.getElementById('user-notification-list');
                userNotificationList.innerHTML = '';
                if (!notifications || notifications.length === 0) {
                    userNotificationList.innerHTML = '<p class="text-gray-500">No notifications.</p>';
                    return;
                }
                notifications.forEach((notif, idx) => {
                    const isRead = notif.status === 'Read';
                    const notifEl = document.createElement('div');
                    notifEl.className = `p-4 border-l-4 rounded-md mb-6 shadow-sm ${isRead ? 'border-gray-200 bg-gray-50' : 'border-blue-500 bg-white'}`;
                    notifEl.innerHTML = `
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-gray-800">${notif.subject}</h3>
                            <span class="text-xs text-gray-500">${new Date(notif.timestamp).toLocaleString()}</span>
                        </div>
                        <p class="mt-2 text-gray-600">${notif.body}</p>
                        <div class="replies-container mt-3 space-y-2">
                            ${notif.reply ? `<div class="text-sm p-2 bg-gray-200 rounded-md whitespace-pre-wrap">${notif.reply}</div>` : ''}
                        </div>
                        ${isRead 
                            ? `<span class="inline-block mt-2 px-3 py-1 text-xs font-semibold bg-green-100 text-green-700 rounded-full">Message Seen</span>` 
                            : `<button class="mark-read-btn mt-2 px-3 py-1 text-xs font-semibold bg-blue-100 text-blue-700 rounded-full">Mark as Read</button>`
                        }
                        <form class="reply-form mt-4 space-y-2" data-message-id="${notif.messageId}">
                            <textarea rows="2" placeholder="Type your reply..." required class="block w-full border-blue-100 bg-blue-50 rounded-md shadow-sm text-sm p-2 focus:bg-blue-100"></textarea>
                            <button type="submit" class="bg-blue-600 text-white font-semibold py-1 px-3 text-sm rounded-md hover:bg-blue-700">Send Reply</button>
                        </form>
                        ${idx < notifications.length - 1 ? '<hr class="my-6 border-gray-300">' : ''}
                    `;
                    userNotificationList.appendChild(notifEl);

                    // Mark as Read button handler
                    if (!isRead) {
                        const markReadBtn = notifEl.querySelector('.mark-read-btn');
                        markReadBtn.addEventListener('click', () => {
                            loaderOverlay.classList.remove('hidden'); // Show loader animation
                            postData({ action: 'markAsRead', messageId: notif.messageId }, (response) => {
                                loaderOverlay.classList.add('hidden'); // Hide loader animation
                                if (response.status === 'success') {
                                    markReadBtn.remove();
                                    notifEl.classList.remove('border-blue-500', 'bg-white');
                                    notifEl.classList.add('border-gray-200', 'bg-gray-50');
                                    const seenBadge = document.createElement('span');
                                    seenBadge.className = 'inline-block mt-2 px-3 py-1 text-xs font-semibold bg-green-100 text-green-700 rounded-full';
                                    seenBadge.textContent = 'Message Seen';
                                    notifEl.insertBefore(seenBadge, notifEl.querySelector('.replies-container').nextSibling);
                                    fetchUserNotifications(); // Refresh notification count and dropdown
                                }
                            });
                        });
                    }

                    // Reply form handler
                    const replyForm = notifEl.querySelector('.reply-form');
                    replyForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        loaderOverlay.classList.remove('hidden'); // Show loader animation
                        const replyText = replyForm.querySelector('textarea').value;

                        // If not already read, mark as read first, then send reply
                        if (!isRead) {
                            postData({ action: 'markAsRead', messageId: notif.messageId }, (markResponse) => {
                                // Now send the reply
                                postData({ action: 'replyToNotification', replyData: { messageId: notif.messageId, replyText } }, (response) => {
                                    loaderOverlay.classList.add('hidden'); // Hide loader animation
                                    if (response.status === 'success') {
                                        replyForm.querySelector('textarea').value = '';
                                        fetchUserNotifications(); // Refresh notifications after reply
                                    }
                                });
                            });
                        } else {
                            // Already read, just send reply
                            postData({ action: 'replyToNotification', replyData: { messageId: notif.messageId, replyText } }, (response) => {
                                loaderOverlay.classList.add('hidden'); // Hide loader animation
                                if (response.status === 'success') {
                                    replyForm.querySelector('textarea').value = '';
                                    fetchUserNotifications(); // Refresh notifications after reply
                                }
                            });
                        }
                    });
                });
            }
            
            // --- ALL OTHER FUNCTIONS (renderDashboard, applyFiltersAndSort, etc.) ---
            // (No changes needed to the rest of your functions, just make sure they are here)

            function renderDashboard(data) {
            if (!data || data.length < 2) {
                    document.getElementById('kpi-in-progress').textContent = 0;
                    document.getElementById('kpi-completed').textContent = 0;
                    document.getElementById('kpi-next-due').textContent = 'N/A';
                    document.getElementById('progress-text').textContent = 'No tasks assigned';
                    document.getElementById('progress-bar').style.width = '0%';
                    return;
                }

                const headers = data[0];
                const tasks = data.slice(1);
                const statusIndex = headers.indexOf("Status");
                const dueDateIndex = headers.indexOf("DueDate");

                let inProgressCount = 0;
                let completedCount = 0;
                let nextDueDate = null;

                tasks.forEach(row => {
                    const status = row[statusIndex];
                    if (status === 'In Progress' || status === 'Assigned') {
                        inProgressCount++;
                        const dueDate = new Date(row[dueDateIndex]);
                        if (!nextDueDate || dueDate < nextDueDate) {
                            nextDueDate = dueDate;
                        }
                    }
                    if (status === 'Completed') {
                        completedCount++;
                    }
                });

                document.getElementById('kpi-in-progress').textContent = inProgressCount;
                document.getElementById('kpi-completed').textContent = completedCount;
                document.getElementById('kpi-next-due').textContent = nextDueDate ? nextDueDate.toLocaleDateString() : 'N/A';

                const totalTasks = tasks.length;
                const progressPercentage = totalTasks > 0 ? (completedCount / totalTasks) * 100 : 0;
                document.getElementById('progress-text').textContent = `${completedCount}/${totalTasks} Tasks Completed`;
                document.getElementById('progress-bar').style.width = `${progressPercentage}%`;
            }
            
            function applyFiltersAndSort() {
                if (!allTasksData || allTasksData.length < 2) {
                    renderTasks(allTasksData);
                    return;
                }

                const headers = allTasksData[0];
                let tasks = allTasksData.slice(1);
                const statusFilter = document.getElementById('statusFilter').value;
                const sortOrder = document.getElementById('sortOrder').value;

                if (statusFilter !== 'All') {
                    tasks = tasks.filter(row => row[headers.indexOf("Status")] === statusFilter);
                } else {
                    tasks = tasks.filter((row) => row[headers.indexOf("Status")] !== 'Completed');
                }
                
                const dueDateIndex = headers.indexOf("DueDate");
                tasks.sort((a, b) => {
                    const dateA = new Date(a[dueDateIndex]);
                    const dateB = new Date(b[dueDateIndex]);
                    return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
                });
                
                renderTasks([headers, ...tasks]);
            }
            
            function renderTasks(data) {
                const container = document.getElementById("tasksContainer");
                container.innerHTML = "";
                
                if (!data || data.length < 2) {
                    container.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md text-center text-gray-500">No tasks match the current filter.</div>`;
                    return;
                }

                const headers = data[0];
                const dataRows = data.slice(1);

                dataRows.forEach(row => {
                    const card = document.createElement("div");
                    const status = row[headers.indexOf("Status")];
                    const dueDate = new Date(row[headers.indexOf("DueDate")]);
                    const today = new Date();
                    today.setHours(0,0,0,0); 
                    
                    const isOverdue = dueDate < today && status !== 'Completed';
                    card.className = `bg-white p-6 rounded-lg shadow-md border-l-4 ${isOverdue ? 'border-red-500' : 'border-transparent'}`;

                    let statusColor = 'bg-blue-100 text-blue-800';
                    if (status === 'In Progress') statusColor = 'bg-yellow-100 text-yellow-800';
                    if (status === 'Completed') statusColor = 'bg-green-100 text-green-800';
                    if (status === 'Blocked') statusColor = 'bg-red-100 text-red-800';

                    card.innerHTML = `
                        <button class="accordion-toggle flex justify-between items-center w-full text-left">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">${row[headers.indexOf("TaskTitle")]}</h3>
                                <p class="text-sm text-gray-500">Due: ${dueDate.toLocaleDateString()}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                ${isOverdue ? '<span class="text-red-500 font-semibold"><i class="fa-solid fa-triangle-exclamation mr-1"></i>Overdue</span>' : ''}
                                <span class="text-sm font-semibold px-3 py-1 rounded-full ${statusColor}">${status}</span>
                                <svg class="accordion-icon w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </button>
                        <div class="accordion-content hidden mt-4 pt-4 border-t">
                            <p class="text-gray-600 mb-4">${row[headers.indexOf("TaskDescription")] || 'No description provided.'}</p>
                            <form class="task-form space-y-3" data-task-id="${row[headers.indexOf("TaskID")]}">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Update Status:</label>
                                    <select name="status" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <option value="Assigned" ${status === 'Assigned' ? 'selected' : ''}>Assigned</option>
                                        <option value="In Progress" ${status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="Completed" ${status === 'Completed' ? 'selected' : ''}>Completed</option>
                                        <option value="Blocked" ${status === 'Blocked' ? 'selected' : ''}>Blocked</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Notes:</label>
                                    <textarea name="notes" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">${row[headers.indexOf("VolunteerNotes")] || ''}</textarea>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition duration-300">Update Task</button>
                            </form>
                        </div>
                    `;
                    container.appendChild(card);
                });

                document.querySelectorAll(".accordion-toggle").forEach(button => {
                    button.addEventListener('click', () => {
                        const content = button.nextElementSibling;
                        const icon = button.querySelector('.accordion-icon');
                        content.classList.toggle('hidden');
                        icon.classList.toggle('rotate-180');
                    });
                });

                document.querySelectorAll(".task-form").forEach(form => {
                    form.addEventListener("submit", e => {
                        e.preventDefault();
                        const updateData = {
                            taskId: form.dataset.taskId,
                            status: form.querySelector("select[name='status']").value,
                            notes: form.querySelector("textarea[name='notes']").value
                        };
                        postData({ action: "updateTask", updateData: updateData });
                    });
                });
            }


            new Choices('#statusFilter', { searchEnabled: false, itemSelectText: '', classNames: { containerInner: 'rounded-xl' } });
            new Choices('#sortOrder', { searchEnabled: false, itemSelectText: '', classNames: { containerInner: 'rounded-xl' } });


            // --- Initial Load ---
            displayMotivation();
            fetchMyTasks(true); 
        });
    </script>
</body>
</html>